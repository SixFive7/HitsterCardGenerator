# v3.0 Playlist Management

**Goal:** Multi-playlist management with server-side persistence using LiteDB.

## Overview

Transform the single-session app into a multi-playlist manager where users can create, save, and resume multiple playlists. Server-side persistence with LiteDB eliminates localStorage limitations. Browser UUID provides lightweight identity without full authentication.

## Key Decisions (from discussion)

- **Database:** LiteDB (NoSQL document DB, .NET-native)
- **Identity:** Browser UUID in localStorage, no auth
- **State:** Server as source of truth, auto-save on every change
- **Data:** Full track data + card PNGs + album art bytes cached
- **API:** RESTful with Problem Details errors
- **UX:** Subtle indicators, error toast with retry, multi-tab prevention

## Data Model

**Playlist:**
```csharp
{
  Id: Guid
  UserId: string (browser UUID)
  Name: string
  LastStep: string ("upload"|"search"|"playlist"|"preview")
  CreatedAt: DateTime
  UpdatedAt: DateTime
  Tracks: List<Track>
}
```

**Track:**
```csharp
{
  SpotifyTrackId: string
  Title: string
  Artist: string
  Year: int
  Genre: string
  AlbumName: string
  AlbumImageUrl: string
  AlbumImagePng: byte[] (cached)
  BackgroundColor: string
  CardFrontPng: byte[]
  CardBackPng: byte[]
}
```

## Phases

### Phase 32: LiteDB Setup
**Goal:** Add LiteDB and create data model with repository pattern
**Research:** Likely (new library integration)
**Research topics:** LiteDB setup, document storage patterns, .NET integration

Tasks:
- Add LiteDB NuGet package
- Create Playlist and Track entity classes
- Create IPlaylistRepository interface
- Implement LiteDbPlaylistRepository with CRUD operations
- Configure LiteDB connection in Program.cs

### Phase 33: Playlist CRUD API
**Goal:** RESTful API endpoints for playlist management
**Research:** Unlikely (internal patterns)

Tasks:
- Create PlaylistEndpoints.cs with REST routes
- GET/POST /api/playlists (list/create)
- GET/PUT/DELETE /api/playlists/{id} (read/update/delete)
- X-User-Id header middleware for user identification
- Problem Details error responses (RFC 7807)

### Phase 34: Playlist Selection UI
**Goal:** Playlist selection page with browser UUID identity
**Research:** Unlikely (internal patterns)

Tasks:
- Generate browser UUID on first visit (store in localStorage)
- Create PlaylistSelection.svelte component
- Empty state for new users ("No playlists yet")
- List view with playlist name + track count
- Inline delete confirmation
- "New Playlist" button â†’ landing page
- Editable playlist name

### Phase 35: Flow Integration
**Goal:** Connect existing flow to playlist persistence
**Research:** Unlikely (internal patterns)

Tasks:
- Modify stores to use server as source of truth
- Auto-save on every change (track add/remove, step change)
- Resume from last step when opening playlist
- Name playlist at creation, editable during editing
- Update navigation to include playlist context

### Phase 36: UX Polish
**Goal:** Error handling, loading states, edge cases
**Research:** Unlikely (internal patterns)

Tasks:
- Subtle loading/saving indicators (spinner in corner)
- Error toast with retry option on network failure
- Multi-tab detection and prevention (warn user)
- Smart back button (confirm if unsaved changes)
- Handle edge cases gracefully

## Progress

| Phase | Plans | Status |
|-------|-------|--------|
| 32. LiteDB Setup | TBD | Not started |
| 33. Playlist CRUD API | TBD | Not started |
| 34. Playlist Selection UI | TBD | Not started |
| 35. Flow Integration | TBD | Not started |
| 36. UX Polish | TBD | Not started |
