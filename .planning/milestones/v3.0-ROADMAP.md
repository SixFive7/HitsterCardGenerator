# Milestone v3.0: Playlist Management

## Status: SHIPPED 2025-12-26

## Goal

Multi-playlist management with server-side LiteDB persistence and browser UUID identity.

## Phases

### Phase 32: LiteDB Setup

**Goal**: Add LiteDB and create data model with repository pattern
**Status**: Complete

Added LiteDB 5.0.21 NuGet package with Playlist and Track models. Implemented ILiteDbContext singleton wrapper with automatic data directory creation. Created IPlaylistRepository and ITrackRepository with CRUD operations and GetOrCreate pattern for track deduplication.

Plans:
- [x] 32-01: Add LiteDB package, models, context, and repositories - 2025-12-26

### Phase 33: Playlist CRUD API

**Goal**: RESTful API endpoints for playlist management
**Status**: Complete

Created full RESTful API with 7 endpoints for playlist and track management. Implemented X-Browser-Id header validation for browser isolation. Security via 404 prevents playlist enumeration.

Plans:
- [x] 33-01: Playlist CRUD endpoints and track management - 2025-12-26

### Phase 34: Playlist Selection UI

**Goal**: Playlist selection page with browser UUID identity
**Status**: Complete

Browser UUID generation with localStorage persistence. Responsive playlist grid (1/2/3 columns). Create modal with auto-focus. Auto-creates "My Playlist" on first visit. Selected playlist indicator.

Plans:
- [x] 34-01: Browser identity, playlist UI components, landing page integration - 2025-12-26

### Phase 35: Flow Integration

**Goal**: Connect existing flow to playlist persistence
**Status**: Complete

Connected CSV import and Spotify search flows to playlist API. Card store syncs with API load/save operations. Track removal syncs with API.

Plans:
- [x] 35-01: Sync card store with API, update CSV/Spotify flows to persist tracks - 2025-12-26

### Phase 36: UX Polish

**Goal**: Error handling, loading states, edge cases
**Status**: Complete

Toast notification system with auto-dismiss. Loading states for API operations. Playlist rename/delete modals. Prevents deleting last playlist.

Plans:
- [x] 36-01: Toast notifications, loading states, playlist rename/delete - 2025-12-26

## Summary

- **Total phases**: 5
- **Total plans**: 5
- **Phase range**: 32-36
- **Duration**: 1 day (2025-12-26)
- **Files changed**: 50 (5,302 insertions, 58 deletions)

## Key Accomplishments

1. **LiteDB Integration**: Embedded database with repository pattern, automatic directory creation, and configurable connection string
2. **RESTful API**: Full CRUD for playlists with 7 endpoints, browser isolation via X-Browser-Id header
3. **Browser Identity**: UUID-based identity persisted to localStorage, enables multi-user on shared server
4. **Playlist UI**: Responsive grid, create/rename/delete modals, selection persistence
5. **Flow Integration**: CSV import and Spotify search automatically persist to selected playlist
6. **UX Polish**: Toast notifications, loading spinners, error handling throughout

## Technical Details

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/playlists | List playlists for browser |
| GET | /api/playlists/{id} | Get playlist with tracks |
| POST | /api/playlists | Create new playlist |
| PUT | /api/playlists/{id} | Update playlist name |
| DELETE | /api/playlists/{id} | Delete playlist |
| POST | /api/playlists/{id}/tracks | Add track to playlist |
| DELETE | /api/playlists/{id}/tracks/{trackId} | Remove track |

### Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| LiteDB singleton | Thread-safe internally, avoids file locking issues |
| GetOrCreate for tracks | Same SpotifyId reuses existing track, prevents duplication |
| Security via 404 | Accessing other browser's playlist returns 404 (not 403) to prevent enumeration |
| Auto-create "My Playlist" | First-time users get working playlist immediately |
| Prevent last playlist delete | Users must always have at least one playlist |

## Files Created

- `Data/ILiteDbContext.cs`, `Data/LiteDbContext.cs`, `Data/LiteDbOptions.cs`
- `Models/Playlist.cs`, `Models/Track.cs`, `Models/PlaylistDto.cs`
- `Repositories/IPlaylistRepository.cs`, `Repositories/PlaylistRepository.cs`
- `Repositories/ITrackRepository.cs`, `Repositories/TrackRepository.cs`
- `Endpoints/PlaylistEndpoints.cs`
- `web/src/lib/stores/browser.svelte.ts`
- `web/src/lib/stores/selectedPlaylist.svelte.ts`
- `web/src/lib/stores/toast.svelte.ts`
- `web/src/lib/Playlists/PlaylistCard.svelte`
- `web/src/lib/Playlists/PlaylistList.svelte`
- `web/src/lib/Playlists/CreatePlaylistModal.svelte`
- `web/src/lib/Playlists/EditPlaylistModal.svelte`
- `web/src/lib/Playlists/DeleteConfirmModal.svelte`
- `web/src/lib/Toast/Toast.svelte`
- `web/src/lib/Toast/ToastContainer.svelte`

## Files Modified

- `HitsterCardGenerator.csproj` - Added LiteDB package
- `Program.cs` - Registered database and playlist services
- `appsettings.json` - Added LiteDbOptions section
- `.gitignore` - Added data/ exclusion
- `web/src/App.svelte` - Integrated playlist selection and API sync
- `web/src/lib/api.ts` - Added playlist API functions and X-Browser-Id header
- `web/src/lib/types.ts` - Added Playlist and Track types
- `web/src/lib/stores/playlist.svelte.ts` - Refactored for API sync
