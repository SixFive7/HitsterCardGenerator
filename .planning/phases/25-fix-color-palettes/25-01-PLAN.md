# Phase 25: Fix Color Palettes - Execution Plan

## Problem Summary

Color palette selection works (UI responds, localStorage updates) but the card preview doesn't update because of a **broken reactive binding chain** in Svelte 5.

### Root Cause Analysis

1. **Store Design Issue**: `cardCustomization.svelte.ts` uses module-level `$state()` with a getter-based export pattern
2. **Reactivity Break**: When `applyPalette()` reassigns `genreColors = { ...palette }`, Svelte tracks the state change internally
3. **Missing Reactive Binding**: `App.svelte` calls `getCardCustomizationState()` once at initialization - the returned object's getter `get genreColors()` is not reactive in Svelte 5's fine-grained reactivity model
4. **Result**: `customizationState.genreColors` accesses the value but doesn't create a reactive dependency, so the component doesn't re-render

### Trace of the Bug

```
User clicks palette → GenreColorPicker.handlePaletteSelect()
  → setGenreColor() called for each genre
  → Store's genreColors object mutated in place (individual keys)
  → BUT: App.svelte has no reactive dependency on these mutations
  → CardCarousel receives stale genreColors prop
  → No update
```

## Solution

Create proper reactive bindings using Svelte 5's `$derived` rune in App.svelte to track store changes.

---

## Tasks

### Task 1: Fix reactive binding in App.svelte

**File**: `web/src/App.svelte`

**Changes**:
1. Import `getGenreColor` function directly from the store (it reads from the reactive state)
2. Create a `$derived` value for `genreColors` that properly tracks the store
3. Alternative approach: Create a reactive snapshot of the colors using `$derived`

**Implementation**:
```typescript
// In App.svelte, add after existing imports:
import { getCardCustomizationState, getGenreColor } from './lib/stores/cardCustomization.svelte'

// Create a derived reactive object for genre colors from match results
const reactiveGenreColors = $derived.by(() => {
  // Build colors object - accessing getGenreColor() for each genre
  // creates reactive dependencies on the store's state
  const colors: Record<string, string> = {}
  for (const result of matchResults) {
    if (result.originalGenre) {
      colors[result.originalGenre] = getGenreColor(result.originalGenre)
    }
  }
  return colors
})
```

Then use `reactiveGenreColors` instead of `customizationState.genreColors` when passing to CardCarousel and ExportStep.

**Rationale**: This approach:
- Creates explicit reactive dependencies through `$derived`
- Only tracks colors for genres actually used in the current results
- Works with Svelte 5's fine-grained reactivity model

### Task 2: Update component props to use reactive colors

**Files**:
- `web/src/App.svelte`

**Changes**:
Update the CardCarousel and ExportStep components to use the new reactive colors:

```svelte
<!-- Line ~529-536: Update CardCarousel -->
<CardCarousel
  cards={matchResults}
  genreColors={reactiveGenreColors}
  ...
/>

<!-- Line ~576-579: Update ExportStep -->
<ExportStep
  matchResults={matchResults}
  genreColors={reactiveGenreColors}
  ...
/>
```

### Task 3: Verify fix with visual testing

**Actions**:
1. Start the dev server
2. Navigate to preview page with test cards
3. Select different palettes (Neon, Pastel, Grayscale, Spotify)
4. Verify card back colors update immediately
5. Flip cards to confirm back face shows new colors

---

## Expected Outcome

- Selecting a color palette immediately updates the card preview
- Individual genre color changes also update in real-time
- No regressions in other functionality (export, localStorage persistence)

## Files Modified

1. `web/src/App.svelte` - Add reactive color binding

## Estimated Effort

Small fix - 15-30 minutes
