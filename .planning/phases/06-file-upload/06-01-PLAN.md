---
phase: 06-file-upload
plan: 01
type: execute
---

<objective>
Implement CSV file upload with drag-drop UI and validation display.

Purpose: Enable users to upload their song CSV via browser, see validation results before proceeding.
Output: Working file upload flow - drag CSV onto page, see parsed songs and any validation errors.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summary:**
@.planning/phases/05-web-foundation/05-02-SUMMARY.md

**Existing services to reuse:**
@Services/CsvParser.cs - Parses CSV, validates genres, returns CsvParseResult
@Models/CsvParseResult.cs - Contains Songs, ValidSongs, InvalidSongs, HasErrors
@Models/Song.cs - Song record with Title, Artist, Year, Genre, ValidationErrors

**Existing patterns:**
@Endpoints/HealthEndpoints.cs - Endpoint registration pattern
@web/src/lib/api.ts - Frontend API helper pattern
@web/src/App.svelte - Current landing page structure

**Key constraints:**
- Reuse existing CsvParser (don't rewrite parsing logic)
- Semicolon-separated CSV format (title;artist;year;genre)
- Match existing Spotify-inspired color theme (#1DB954 green, #FF6B6B coral, #191414 dark)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV upload API endpoint</name>
  <files>Endpoints/CsvEndpoints.cs, Program.cs</files>
  <action>
Create POST /api/csv/upload endpoint that:
1. Accepts multipart/form-data with a single file
2. Saves file temporarily, calls CsvParser.ParseFile()
3. Returns JSON with parsing results:
   ```json
   {
     "success": true/false,
     "totalSongs": number,
     "validSongs": [...],
     "invalidSongs": [...],
     "errorSummary": "string"
   }
   ```
4. Cleans up temp file after parsing

Follow HealthEndpoints.cs pattern for endpoint registration.
Register CsvEndpoints in Program.cs with app.MapCsvEndpoints().

Return appropriate HTTP status codes:
- 200: File parsed (even if validation errors exist)
- 400: No file provided or not a CSV
- 500: Unexpected error
  </action>
  <verify>
curl -X POST http://localhost:5657/api/csv/upload -F "file=@test.csv" returns JSON response
  </verify>
  <done>
Endpoint accepts CSV file upload, returns structured validation results using existing CsvParser
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileUpload Svelte component</name>
  <files>web/src/lib/FileUpload.svelte, web/src/lib/api.ts, web/src/lib/types.ts</files>
  <action>
Create types.ts with TypeScript interfaces:
- Song: { title, artist, year, genre, validationErrors: string[] }
- CsvUploadResponse: { success, totalSongs, validSongs: Song[], invalidSongs: Song[], errorSummary }

Add uploadCsv(file: File) function to api.ts that POSTs to /api/csv/upload.

Create FileUpload.svelte component with:
1. Drag-drop zone with dashed border, centered text "Drop CSV file here or click to select"
2. Hidden file input triggered by click on drop zone
3. Visual feedback:
   - Default: dashed border, muted text
   - Dragover: green border (#1DB954), "Drop to upload" text
   - Uploading: spinner, "Processing..." text
4. On file drop/select: call uploadCsv(), emit 'uploaded' event with response
5. Accept only .csv files

Use Svelte 5 runes ($state for dragover/uploading states).
Style with Tailwind classes matching existing theme.
  </action>
  <verify>Component renders with drop zone, accepts file input</verify>
  <done>FileUpload component handles drag-drop and file selection, calls API, emits results</done>
</task>

<task type="auto">
  <name>Task 3: Integrate upload flow and display results</name>
  <files>web/src/App.svelte</files>
  <action>
Update App.svelte to add upload flow after landing:

1. Add state: uploadResult (null initially), currentStep ('landing' | 'upload' | 'results')
2. Add "Get Started" button on landing that sets currentStep = 'upload'
3. Upload step:
   - Show FileUpload component
   - On 'uploaded' event: store result, move to 'results' step
4. Results step:
   - Show summary: "X songs parsed, Y valid, Z with errors"
   - If errors: show error panel with red background, list each invalid song with its errors
   - If all valid: show success panel with green background
   - Show table/list of valid songs (title, artist, year, genre)
   - "Upload Different File" button to return to upload step

Style validation results:
- Valid songs: card with song info, subtle green left border
- Invalid songs: card with song info + errors, red left border
- Use existing color palette
  </action>
  <verify>npm run dev shows landing → upload → results flow</verify>
  <done>Full upload flow works: landing → file upload → validation results display</done>
</task>

<task type="auto">
  <name>Task 4: Verify upload flow with Playwright</name>
  <files>None (uses webapp-testing skill)</files>
  <action>
Use /webapp-testing skill to verify the complete flow:

1. Start both servers (dotnet run + npm run dev)
2. Navigate to http://localhost:5173
3. Take screenshot of landing page
4. Click "Get Started" button
5. Take screenshot of upload page (should show drop zone)
6. Create a test CSV file and upload it via the file input
7. Take screenshot of results page
8. Verify:
   - Drop zone is visible and styled correctly
   - Results display shows song count
   - Valid/invalid songs are distinguished visually

Test with both valid CSV and CSV with errors to verify error display.
  </action>
  <verify>Playwright screenshots confirm UI renders correctly at each step</verify>
  <done>Visual verification complete - upload flow works end-to-end</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `dotnet build` succeeds without errors
- [ ] `npm run build` (in web/) succeeds without errors
- [ ] POST /api/csv/upload accepts file and returns JSON
- [ ] Frontend drag-drop zone accepts CSV files
- [ ] Validation results display correctly (valid vs invalid songs)
- [ ] Playwright screenshots confirm visual correctness
</verification>

<success_criteria>
- CSV upload endpoint works with existing CsvParser
- Drag-drop file upload component styled consistently
- Validation results clearly show valid vs invalid songs
- Error messages from CsvParser displayed to user
- Full flow verified with Playwright
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-upload/06-01-SUMMARY.md`
</output>
