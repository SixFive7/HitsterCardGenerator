---
phase: 02-csv-import
plan: 01
type: execute
---

<objective>
Create data layer for CSV import: Song model, genre validation, and CSV parser.

Purpose: Establish the core data structures and parsing logic that the wizard UI will consume.
Output: Song record, Genre enum with 35+ genres, CsvParser service returning validation results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Semicolon CSV separator (song titles may contain commas)
- 85x55mm card size with 16 per A4 (informs what data we need per song)

**Relevant source files:**
@Models/Step.cs
@Models/WizardState.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Song model</name>
  <files>Models/Song.cs</files>
  <action>
Create a Song record with properties:
- Title (string, required)
- Artist (string, required)
- Year (int, required, must be 1900-2099)
- Genre (string, required)
- SpotifyTrackId (string?, nullable - populated later in Phase 3)

Use C# record type for immutability. Add a ValidationErrors property (List<string>) to collect validation issues per song. Add a static Parse method that takes a CSV line and returns a Song with any validation errors populated.
  </action>
  <verify>dotnet build succeeds, Song record is usable in test code</verify>
  <done>Song.cs exists with record definition, Parse method, and ValidationErrors property</done>
</task>

<task type="auto">
  <name>Task 2: Create genre validation</name>
  <files>Models/Genre.cs, Services/GenreValidator.cs</files>
  <action>
Create Genre.cs with a static class containing:
- AllGenres: HashSet<string> with 30+ popular genres (Rock, Pop, Hip-Hop, R&B, Country, Jazz, Blues, Electronic, Dance, House, Techno, Classical, Reggae, Soul, Funk, Disco, Metal, Punk, Alternative, Indie, Folk, Latin, Rap, Gospel, World, Ambient, New Wave, Grunge, Ska, Synthpop)
- FrenchGenres: HashSet<string> with 5 French genres (Chanson, Variete Francaise, French Pop, French Hip-Hop, Musette)
- A combined ValidGenres HashSet (union of both, case-insensitive comparison)

Create GenreValidator.cs service:
- IsValidGenre(string genre) -> bool (case-insensitive check)
- GetClosestMatch(string genre) -> string? (simple Levenshtein or contains-based suggestion for typos)
- NormalizeGenre(string genre) -> string (returns properly-cased version from ValidGenres)
  </action>
  <verify>dotnet build succeeds, GenreValidator.IsValidGenre("rock") returns true, IsValidGenre("xyz") returns false</verify>
  <done>Genre.cs has 35+ genres, GenreValidator validates case-insensitively and suggests close matches</done>
</task>

<task type="auto">
  <name>Task 3: Create CSV parser service</name>
  <files>Services/CsvParser.cs, Models/CsvParseResult.cs</files>
  <action>
Create CsvParseResult.cs:
- Songs: List<Song> (all parsed songs)
- ValidSongs: List<Song> (songs with no validation errors)
- InvalidSongs: List<Song> (songs with validation errors)
- HasErrors: bool
- ErrorSummary: string (e.g., "3 of 50 songs have validation errors")

Create CsvParser.cs service:
- ParseFile(string filePath) -> CsvParseResult
- Uses semicolon separator
- Expects header row: title;artist;year;genre (case-insensitive)
- Validates each row:
  - All 4 fields present and non-empty
  - Year is valid integer in range 1900-2099
  - Genre passes GenreValidator.IsValidGenre()
- Populates Song.ValidationErrors for each issue found
- Returns CsvParseResult with categorized songs

Handle edge cases:
- File not found -> throw FileNotFoundException with clear message
- Empty file -> return result with 0 songs
- Missing header -> add error to first "song" explaining expected format
- Malformed rows (wrong column count) -> add to InvalidSongs with error
  </action>
  <verify>Create a test CSV file, run parser, confirm ValidSongs and InvalidSongs are correctly categorized</verify>
  <done>CsvParser parses semicolon-separated CSV, validates all fields, returns categorized results with clear error messages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors or warnings
- [ ] Song record has all required properties including ValidationErrors
- [ ] Genre.ValidGenres contains 35+ genres (30 popular + 5 French)
- [ ] GenreValidator correctly validates known and unknown genres
- [ ] CsvParser handles valid CSV, invalid rows, and edge cases
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors (N/A - this is C#)
- No build warnings
- Data layer ready for UI integration in 02-02-PLAN.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-csv-import/02-01-SUMMARY.md`
</output>
