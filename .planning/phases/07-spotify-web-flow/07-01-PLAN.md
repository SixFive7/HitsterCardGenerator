---
phase: 07-spotify-web-flow
plan: 01
type: execute
---

<objective>
Create backend API for Spotify track matching with confidence scoring and alternatives.

Purpose: Enable the frontend to match uploaded songs to Spotify tracks with visual feedback on match quality.
Output: POST /api/match endpoint returning matches with album art, confidence levels, and alternative suggestions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-spotify-web-flow/07-CONTEXT.md
@.planning/phases/07-spotify-web-flow/07-RESEARCH.md

**Prior decisions affecting this phase:**
- Phase 3: SpotifyService uses Client Credentials flow (no user OAuth needed)
- Phase 3: Smart selection priority: album > single > compilation, non-remastered preferred
- Phase 6: Valid songs available in CsvUploadResponse.validSongs

**Key context from CONTEXT.md:**
- Host-provided credentials via .env (gitignored)
- Credentials provided via environment variables (see .env.example)
- No user OAuth - reuse existing Client Credentials flow
- Show 3-5 alternatives when confidence < high

**Key context from RESEARCH.md:**
- Confidence: categorical (high/medium/low), not percentages
- AlbumImageUrl from track.Album.Images.FirstOrDefault()?.Url
- Simple heuristic: exact match = high, partial = medium, different = low

**Relevant source files:**
@Services/SpotifyService.cs
@Models/SpotifySearchResult.cs
@Endpoints/CsvEndpoints.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SpotifySearchResult with AlbumImageUrl</name>
  <files>Models/SpotifySearchResult.cs, Services/SpotifyService.cs</files>
  <action>
    1. Add `AlbumImageUrl` property to SpotifySearchResult record:
       ```csharp
       public string AlbumImageUrl { get; init; } = string.Empty;
       ```
    2. Update MapToSearchResult in SpotifyService.cs to populate it:
       ```csharp
       AlbumImageUrl = track.Album?.Images?.FirstOrDefault()?.Url ?? string.Empty
       ```
    3. Keep all existing properties unchanged
  </action>
  <verify>dotnet build succeeds with no errors</verify>
  <done>SpotifySearchResult includes AlbumImageUrl, populated from Spotify API response</done>
</task>

<task type="auto">
  <name>Task 2: Create Match endpoint with confidence and alternatives</name>
  <files>Endpoints/MatchEndpoints.cs, Models/MatchResult.cs, Program.cs, appsettings.json, appsettings.Development.json</files>
  <action>
    1. Create Models/MatchResult.cs:
       ```csharp
       public record MatchResult
       {
           public int Index { get; init; }
           public string OriginalTitle { get; init; } = string.Empty;
           public string OriginalArtist { get; init; } = string.Empty;
           public int OriginalYear { get; init; }
           public string OriginalGenre { get; init; } = string.Empty;
           public SpotifySearchResult? Match { get; init; }
           public string Confidence { get; init; } = "none"; // "high", "medium", "low", "none"
           public List<SpotifySearchResult> Alternatives { get; init; } = new();
       }

       public record MatchRequest
       {
           public List<SongInput> Songs { get; init; } = new();
       }

       public record SongInput
       {
           public string Title { get; init; } = string.Empty;
           public string Artist { get; init; } = string.Empty;
           public int Year { get; init; }
           public string Genre { get; init; } = string.Empty;
       }

       public record MatchResponse
       {
           public bool Success { get; init; }
           public List<MatchResult> Results { get; init; } = new();
           public int TotalMatched { get; init; }
           public int TotalNotFound { get; init; }
       }
       ```

    2. Add Spotify credentials to appsettings.Development.json (gitignored):
       ```json
       {
         "Spotify": {
           "ClientId": "<your-client-id>",
           "ClientSecret": "<your-client-secret>"
         }
       }
       ```
       Also add placeholder to appsettings.json:
       ```json
       {
         "Spotify": {
           "ClientId": "",
           "ClientSecret": ""
         }
       }
       ```

    3. Create Endpoints/MatchEndpoints.cs with:
       - POST /api/match accepting MatchRequest
       - Create SpotifyService from config, authenticate once
       - For each song: search, select best match, calculate confidence
       - Confidence calculation (simple heuristic):
         - Exact title AND artist match (case-insensitive) = "high"
         - Exact title OR artist match = "medium"
         - Match returned but neither exact = "low"
         - No results = "none"
       - Return top match + up to 4 alternatives (from remaining results)
       - Return MatchResponse with all results

    4. Register in Program.cs: app.MapMatchEndpoints()

    **Important:** Do NOT over-engineer confidence scoring. Spotify's search is already fuzzy-matching. Simple string comparison is sufficient.
  </action>
  <verify>
    curl -X POST http://localhost:5000/api/match \
      -H "Content-Type: application/json" \
      -d '{"songs":[{"title":"Bohemian Rhapsody","artist":"Queen","year":1975,"genre":"Rock"}]}' \
    returns JSON with match, confidence, and alternatives
  </verify>
  <done>POST /api/match returns matches with confidence levels (high/medium/low/none) and up to 4 alternatives per song</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] SpotifySearchResult.AlbumImageUrl is populated (non-empty for matched tracks)
- [ ] POST /api/match returns correct confidence levels
- [ ] Alternatives array contains up to 4 results (excluding the primary match)
- [ ] "none" confidence returned for songs with no Spotify results
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Match API correctly authenticates with Spotify and returns structured results
</success_criteria>

<output>
After completion, create `.planning/phases/07-spotify-web-flow/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Backend Match API Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Tasks:** 2
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 07-02-PLAN.md (Frontend Match UI)
</output>
