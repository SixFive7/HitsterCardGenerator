---
phase: 07-spotify-web-flow
plan: 02
type: execute
---

<objective>
Create frontend UI for displaying Spotify match results with confidence badges and alternative selection.

Purpose: Give users visual feedback on match quality and ability to correct wrong matches with one click.
Output: MatchResults component integrated into App.svelte flow, auto-starting after successful CSV upload.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-spotify-web-flow/07-CONTEXT.md
@.planning/phases/07-spotify-web-flow/07-RESEARCH.md
@.planning/phases/07-spotify-web-flow/07-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Phase 5: Svelte 5 runes ($state, $effect), Tailwind v4, Spotify-inspired colors
- Phase 6: Three-step flow (landing → upload → results), CsvUploadResponse structure

**Key context from CONTEXT.md:**
- Auto-start matching after upload (no extra clicks)
- Album art displayed alongside each match
- Confidence indicators: exact match (high), close match (medium), uncertain (low)
- Click-to-select for alternatives (no modals)
- "Not found" state for unmatched songs (visible but not blocking)

**Key context from RESEARCH.md:**
- Confidence colors: green (high), amber (medium), red (low)
- Inline alternative selection (click anywhere on row)
- Progress indicator during matching (simple polling or synchronous)

**Relevant source files:**
@web/src/App.svelte
@web/src/lib/api.ts
@web/src/lib/types.ts
@web/src/lib/FileUpload.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MatchResults component with album art and alternatives</name>
  <files>web/src/lib/MatchResults.svelte, web/src/lib/types.ts, web/src/lib/api.ts</files>
  <action>
    1. Add TypeScript interfaces to types.ts:
       ```typescript
       export interface SpotifyMatch {
         trackId: string
         trackName: string
         artistName: string
         albumName: string
         albumImageUrl: string
         spotifyUrl: string
       }

       export interface MatchResult {
         index: number
         originalTitle: string
         originalArtist: string
         originalYear: number
         originalGenre: string
         match: SpotifyMatch | null
         confidence: 'high' | 'medium' | 'low' | 'none'
         alternatives: SpotifyMatch[]
       }

       export interface MatchResponse {
         success: boolean
         results: MatchResult[]
         totalMatched: number
         totalNotFound: number
       }
       ```

    2. Add matchSongs function to api.ts:
       ```typescript
       export async function matchSongs(songs: Song[]): Promise<MatchResponse> {
         const response = await fetch('/api/match', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
             songs: songs.map(s => ({
               title: s.title,
               artist: s.artist,
               year: s.year,
               genre: s.genre
             }))
           })
         })
         if (!response.ok) throw new Error('Failed to match songs')
         return response.json()
       }
       ```

    3. Create web/src/lib/MatchResults.svelte:
       - Props: results (MatchResult[]), onSelectAlternative callback
       - For each result, display:
         - Album art (64x64, rounded, placeholder if no match)
         - Track name + artist name
         - Confidence badge (color-coded: green/amber/red)
         - "Change" button that toggles alternatives visibility
       - Alternatives panel (shown on click):
         - List of up to 4 alternatives with smaller album art (40x40)
         - Click anywhere on row to select
       - "Not found" state for confidence="none":
         - Gray placeholder, "Not found: {original title}" text
       - Use Tailwind classes matching existing design (bg-[#282828], text-white, etc.)
       - Use Svelte 5 runes ($state for showAlternatives per result)

    **Confidence badge colors:**
    - high: bg-green-500, text "Exact"
    - medium: bg-amber-500, text "Close"
    - low: bg-red-500, text "Uncertain"
    - none: no badge, show "Not found" styling
  </action>
  <verify>Component imports without errors, TypeScript types compile</verify>
  <done>MatchResults component displays matches with album art, confidence badges, and clickable alternatives</done>
</task>

<task type="auto">
  <name>Task 2: Integrate matching flow into App.svelte</name>
  <files>web/src/App.svelte</files>
  <action>
    1. Add new step to state machine: 'matching' between 'results' and new 'matched' step
       - Flow: landing → upload → results → matching → matched
       - 'results' shows CSV validation (existing)
       - 'matching' shows progress indicator
       - 'matched' shows MatchResults component

    2. Add state variables:
       ```typescript
       let matchResults = $state<MatchResult[]>([])
       let matchingProgress = $state<{ current: number; total: number } | null>(null)
       ```

    3. Add "Match with Spotify" button on results page (replace disabled "Generate Cards"):
       - Only enabled if validSongs.length > 0
       - On click: transition to 'matching' step, call matchSongs API

    4. Create matching progress UI (simple):
       - Show "Matching songs with Spotify..." with spinner
       - Can show "Processing X of Y songs" if desired (but API is synchronous, so may just show spinner)

    5. Handle match completion:
       - Store results in matchResults
       - Transition to 'matched' step

    6. Create 'matched' step UI:
       - Header: "Spotify Matches"
       - Summary card: X matched, Y not found
       - MatchResults component with results
       - Handle onSelectAlternative: update matchResults array with new selection
       - "Continue to Preview" button (disabled, coming in Phase 8)
       - "Re-upload CSV" button to go back to upload step

    **Important:** Keep existing results page UI intact - just replace the disabled button with working "Match with Spotify" button.
  </action>
  <verify>
    1. Start dev server (dotnet run + npm run dev)
    2. Upload valid CSV
    3. Click "Match with Spotify"
    4. See progress indicator
    5. See match results with album art and confidence badges
    6. Click "Change" on a result, see alternatives
    7. Click alternative, see it replace the primary match
  </verify>
  <done>Complete flow from CSV upload through Spotify matching with visual results and alternative selection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds in web/ directory
- [ ] Match results display with album art (or placeholder for not found)
- [ ] Confidence badges show correct colors (green/amber/red)
- [ ] Clicking "Change" reveals alternatives
- [ ] Clicking alternative swaps it as the primary match
- [ ] "Not found" songs display appropriately without blocking flow
- [ ] Full flow works: upload CSV → validate → match → see results
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript or build errors
- Users can match songs and correct wrong matches with single clicks
- Phase 7 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-spotify-web-flow/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Frontend Match UI Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Tasks:** 2
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 7 complete, ready for Phase 8 (Card Preview)
</output>
