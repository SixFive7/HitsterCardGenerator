---
phase: 14-docker-image
plan: 01
type: execute
---

<objective>
Create production-ready Docker image with multi-stage build, non-root user, and environment variable configuration.

Purpose: Enable containerized deployment of the Hitster Card Generator application.
Output: Dockerfile, .dockerignore, and updated Program.cs for Docker compatibility.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-docker-image/14-RESEARCH.md
@.planning/phases/14-docker-image/14-CONTEXT.md

**Prior decisions affecting this phase:**
- Phase 11: MSBuild NpmInstall/NpmBuild targets run only in Release mode (Docker will use Release)
- Phase 10: .NET serves Svelte frontend from wwwroot (single container, no separate frontend)

**Relevant source files:**
@Program.cs
@HitsterCardGenerator.csproj
@Endpoints/HealthEndpoints.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .dockerignore file</name>
  <files>.dockerignore</files>
  <action>
Create .dockerignore to exclude build artifacts and development files from Docker context.

Include:
- **/bin/ and **/obj/ (build artifacts)
- **/node_modules/ (will be installed fresh in build stage)
- **/.git/ (version control)
- **/.vs/ and **/.vscode/ (IDE files)
- **/Dockerfile* and **/.dockerignore (meta files)
- **/*.user and **/*.md (user files and docs)
- .planning/ (GSD workflow files)
- .devcontainer/ (dev environment)
- wwwroot/ (will be built fresh from web/ source)

This ensures the Docker build context is minimal and the build is reproducible.
  </action>
  <verify>File exists at .dockerignore, contains expected patterns</verify>
  <done>.dockerignore created with all necessary exclusions</done>
</task>

<task type="auto">
  <name>Task 2: Update Program.cs for Docker compatibility</name>
  <files>Program.cs</files>
  <action>
Remove the hardcoded port configuration `app.Urls.Add("http://localhost:5000")` from Program.cs.

**Why:** The hardcoded URL overrides environment variables like ASPNETCORE_HTTP_PORTS. For Docker to work with the non-root user pattern (port 8080), we need environment variables to take precedence.

**After change:**
- Local development: launchSettings.json provides applicationUrl
- Docker: ASPNETCORE_HTTP_PORTS=8080 in Dockerfile
- Production: Environment variable configuration

Delete only the line `app.Urls.Add("http://localhost:5000");` and its comment. Do NOT add any conditional logic - just remove it.
  </action>
  <verify>Program.cs no longer contains "app.Urls.Add", `dotnet build` succeeds</verify>
  <done>Program.cs updated - port configuration delegated to environment/launchSettings</done>
</task>

<task type="auto">
  <name>Task 3: Create multi-stage Dockerfile</name>
  <files>Dockerfile</files>
  <action>
Create Dockerfile with multi-stage build following the patterns from 14-RESEARCH.md.

**Stage 1: Build (sdk:10.0)**
1. Use `mcr.microsoft.com/dotnet/sdk:10.0` as build base
2. Set WORKDIR /src
3. Install Node.js for frontend build:
   `RUN apt-get update && apt-get install -y nodejs npm && rm -rf /var/lib/apt/lists/*`
4. Copy dependency files first for cache optimization:
   - Copy *.csproj
   - Copy web/package*.json to web/
5. Run `dotnet restore`
6. Copy remaining source files
7. Run `dotnet publish -c Release -o /app/publish`
   (This triggers NpmInstall and NpmBuild targets automatically via MSBuild)

**Stage 2: Runtime (aspnet:10.0)**
1. Use `mcr.microsoft.com/dotnet/aspnet:10.0`
2. Set WORKDIR /app
3. Copy --from=build /app/publish .
4. Set environment variable: ENV ASPNETCORE_HTTP_PORTS=8080
5. Document required runtime env vars in comments:
   - SPOTIFY_CLIENT_ID (required)
   - SPOTIFY_CLIENT_SECRET (required)
6. Switch to non-root user: USER $APP_UID
7. EXPOSE 8080
8. HEALTHCHECK using curl to /api/health (with fallback if curl not available)
9. ENTRYPOINT ["dotnet", "HitsterCardGenerator.dll"]

**Notes:**
- Do NOT bake secrets into the image - document they must be passed at runtime
- The NpmBuild target only runs in Release mode, which `dotnet publish -c Release` triggers
  </action>
  <verify>
`docker build -t hitster-card-generator .` succeeds
`docker images | grep hitster` shows reasonable image size (~250MB expected)
  </verify>
  <done>Dockerfile created with multi-stage build, non-root user, port 8080, health check</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `.dockerignore` exists with proper exclusions
- [ ] `Program.cs` no longer has hardcoded port
- [ ] `dotnet build` succeeds (no regression)
- [ ] `docker build -t hitster-card-generator .` succeeds
- [ ] `docker run --rm -e SPOTIFY_CLIENT_ID=test -e SPOTIFY_CLIENT_SECRET=test -p 8080:8080 hitster-card-generator` starts
- [ ] `curl http://localhost:8080/api/health` returns OK (container health)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Docker image builds successfully
- Image runs with non-root user on port 8080
- Health endpoint accessible in container
- No secrets baked into image
</success_criteria>

<output>
After completion, create `.planning/phases/14-docker-image/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Docker Image Summary

**[One-liner summary of what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `Dockerfile` - Multi-stage build configuration
- `.dockerignore` - Build context exclusions
- `Program.cs` - Removed hardcoded port

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 15 (GitHub Actions CI)
</output>
