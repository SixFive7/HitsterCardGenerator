# Plan 35-01: Flow Integration

## Objective

Connect existing CSV import and Spotify search flows to playlist persistence, syncing the card store with the playlist API so tracks automatically save to the currently selected playlist.

**Purpose:** Enable users to persist their tracks to the selected playlist regardless of input method (CSV or Spotify search), making the playlist a true source of truth.

**Output:** Updated store that syncs with API, modified CSV import and Spotify search flows that persist tracks to selected playlist.

## Context

**Current State:**
- Phase 34 implemented playlist selection UI with browser UUID identity
- API has full CRUD endpoints at `/api/playlists` and `/api/playlists/{id}/tracks`
- `playlist.svelte.ts` store manages tracks in-memory (session-only)
- `selectedPlaylist.svelte.ts` stores selected playlist ID in localStorage
- CSV import matches songs with Spotify but doesn't persist to playlist
- Spotify search adds tracks to in-memory store but doesn't persist to API

**Target State:**
- Card store syncs with playlist API (loads tracks from selected playlist)
- CSV import saves matched tracks to selected playlist after matching
- Spotify search saves tracks to selected playlist immediately
- Card preview/export uses tracks from selected playlist

**Files to reference:**
- `web/src/lib/stores/playlist.svelte.ts` - Current in-memory track store
- `web/src/lib/stores/selectedPlaylist.svelte.ts` - Selected playlist ID store
- `web/src/lib/api.ts` - API functions (missing addTrackToPlaylist, getPlaylistTracks)
- `web/src/App.svelte` - Main app with CSV import and Spotify search flows
- `web/src/lib/types.ts` - Type definitions
- `Endpoints/PlaylistEndpoints.cs` - API endpoints (POST tracks, GET playlist detail)

**Prior decisions affecting this phase:**
- Track deduplication handled by API (GetOrCreate pattern in Phase 33)
- Browser ID sent via X-Browser-Id header on all requests
- Playlist tracks returned via GET /api/playlists/{id} (includes track list)

## Tasks

### Task 1: Sync Card Store with Playlist API

**Files to modify:**
- `web/src/lib/api.ts` - Add addTrackToPlaylist function
- `web/src/lib/types.ts` - Add PlaylistDetail type for API response
- `web/src/lib/stores/playlist.svelte.ts` - Refactor to sync with API

**Action:**

1. Add `PlaylistDetail` type to `types.ts`:
```typescript
export interface TrackDto {
  id: string
  spotifyId: string
  title: string
  artist: string
  year: number
  genre: string
  albumArtUrl: string | null
}

export interface PlaylistDetail {
  id: string
  name: string
  tracks: TrackDto[]
  createdAt: string
  updatedAt: string
}
```

2. Add API functions to `api.ts`:
```typescript
export async function getPlaylistDetail(id: string): Promise<PlaylistDetail> {
  const response = await fetch(`/api/playlists/${encodeURIComponent(id)}`, {
    headers: getHeaders()
  })
  if (!response.ok) throw new Error('Failed to get playlist')
  return response.json()
}

export async function addTrackToPlaylist(
  playlistId: string,
  track: {
    spotifyId: string
    title: string
    artist: string
    year: number
    genre: string
    albumArtUrl?: string
  }
): Promise<void> {
  const response = await fetch(`/api/playlists/${encodeURIComponent(playlistId)}/tracks`, {
    method: 'POST',
    headers: getHeaders('application/json'),
    body: JSON.stringify({
      spotifyId: track.spotifyId,
      title: track.title,
      artist: track.artist,
      year: track.year,
      genre: track.genre,
      albumArtUrl: track.albumArtUrl
    })
  })
  if (!response.ok) throw new Error('Failed to add track to playlist')
}

export async function removeTrackFromPlaylist(playlistId: string, trackId: string): Promise<void> {
  const response = await fetch(`/api/playlists/${encodeURIComponent(playlistId)}/tracks/${encodeURIComponent(trackId)}`, {
    method: 'DELETE',
    headers: getHeaders()
  })
  if (!response.ok) throw new Error('Failed to remove track from playlist')
}
```

3. Refactor `playlist.svelte.ts` to sync with API:
- Keep the existing PlaylistTrack interface and store shape
- Add `loadTracksFromPlaylist(playlistId: string)` function that fetches from API and populates store
- Update `addTrack()` to also call `addTrackToPlaylist()` API
- Update `removeTrack()` to also call `removeTrackFromPlaylist()` API
- Track needs to store the API track ID for removal
- Keep playlist ID context for API calls

**Verify:**
- `getPlaylistDetail()` returns tracks from API
- `addTrackToPlaylist()` persists track to API
- `loadTracksFromPlaylist()` populates local store from API

**Done:** Card store syncs with playlist API for load and save operations

---

### Task 2: Update CSV Import and Spotify Search Flows

**Files to modify:**
- `web/src/App.svelte` - Update both flows to persist tracks

**Action:**

1. Update the CSV import flow (`handleContinueToPreview`):
- After Spotify matching completes, save matched tracks to selected playlist
- Map `MatchResult[]` to track data and call `addTrackToPlaylist()` for each
- Update `matchResults` state to include API track IDs for removal capability

2. Update playlist load on selection change:
- In App.svelte, add an effect that loads tracks when `selectedPlaylistId` changes
- Call `loadTracksFromPlaylist()` when playlist is selected
- This syncs the local store with persisted data

3. Update Spotify search flow:
- The `addTrack()` function from store now handles API persistence
- Ensure selected playlist ID is passed when adding tracks
- Update `SpotifySearch` to use the new API-synced addTrack

4. Update `handleContinueToPreviewFromBuild`:
- Load tracks from playlist store (already synced with API)
- Convert to `MatchResult[]` format for preview/export
- No additional API calls needed since store is already synced

5. Ensure card preview/export uses synced data:
- Both flows already use `matchResults` for preview/export
- After this change, `matchResults` will be populated from API-synced store

**Key integration points:**
- When selecting a playlist: Load tracks from API into store
- When adding track via Spotify search: Save to API immediately
- When completing CSV match: Save all matched tracks to API
- When viewing preview/export: Use tracks from synced store

**Verify (Chrome DevTools MCP):**
- CSV import: After matching, tracks appear in selected playlist
- Spotify search: Adding a track persists to API (visible after page reload)
- Playlist selection: Loading a playlist shows its persisted tracks
- Preview/export: Shows tracks from selected playlist

**Done:** CSV import and Spotify search flows persist tracks to selected playlist

---

## Verification

Before declaring phase complete:
- [ ] `npm run build` succeeds in web/
- [ ] `dotnet build` succeeds
- [ ] CSV import saves matched tracks to selected playlist
- [ ] Spotify search saves tracks to selected playlist immediately
- [ ] Switching playlists loads tracks from API
- [ ] Card preview shows tracks from selected playlist
- [ ] Tracks persist across page reload

## Success Criteria

1. Card store syncs with playlist API (load/save)
2. CSV import persists matched tracks to selected playlist
3. Spotify search persists tracks to selected playlist immediately
4. Switching playlists loads correct tracks from API
5. Card preview/export uses playlist tracks

## Technical Notes

**Store Refactoring:**
The `playlist.svelte.ts` store will be refactored to include playlist context. It needs to know which playlist to sync with. The selected playlist ID will be passed to load/save functions.

**Track ID Mapping:**
The API returns track IDs from LiteDB. We need to store these IDs so we can call the remove endpoint later. The PlaylistTrack type will be extended to include `id` (API track ID).

**Error Handling:**
For Phase 35, API errors will be logged to console. User-facing error toasts are deferred to Phase 36 (UX Polish).

**CSV Import Flow:**
After Spotify matching, we iterate through matched results and call `addTrackToPlaylist()` for each. This leverages the API's GetOrCreate pattern for track deduplication.

## Out of Scope (Phase 36)

- Playlist rename/delete UI
- Error toasts for failed saves
- Loading states during sync
- Offline support

## Output

After completion, create `.planning/phases/35-flow-integration/35-01-SUMMARY.md`:

```markdown
# Phase 35: Flow Integration Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [ ] Card store syncs with playlist API
- [ ] CSV import persists tracks to selected playlist
- [ ] Spotify search persists tracks to selected playlist
- [ ] Playlist selection loads tracks from API

## Files Created/Modified

- `web/src/lib/api.ts` - Added track management API functions
- `web/src/lib/types.ts` - Added PlaylistDetail, TrackDto types
- `web/src/lib/stores/playlist.svelte.ts` - Refactored for API sync
- `web/src/App.svelte` - Updated flows to persist tracks

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| ... | ... |

## Issues Encountered

None / List any issues

## Next Phase Readiness

Ready for Phase 36: UX Polish
```
