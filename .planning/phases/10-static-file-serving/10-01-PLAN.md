---
phase: 10-static-file-serving
plan: 01
type: execute
---

<objective>
Configure .NET Minimal API to serve Svelte build output and enable single-origin deployment.

Purpose: Eliminate the need to run separate dev servers - .NET serves both API and frontend.
Output: Working static file serving with SPA fallback routing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current state:**
- Program.cs has Minimal API configured on port 5657
- API endpoints use `/api/` prefix (health, csv, match, export)
- Svelte app builds to `web/dist/` with hashed assets
- `wwwroot/` directory exists but is empty
- Svelte API client uses relative `/api/` paths (will work when same-origin)

**Key files:**
@Program.cs
@web/dist/index.html (build output entry point)

**Prior decisions:**
- Phase 5: Vite proxies `/api` to localhost:5657 during dev
- All API routes use `/api/` prefix for clean separation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add static file middleware to Program.cs</name>
  <files>Program.cs</files>
  <action>
Add static file serving middleware to Program.cs:

1. Add `app.UseDefaultFiles()` BEFORE `app.UseStaticFiles()` - this serves index.html for root requests
2. Add `app.UseStaticFiles()` to serve files from wwwroot
3. Add SPA fallback AFTER API routes - use `app.MapFallbackToFile("index.html")` to handle client-side routing

Order matters:
```
app.UseDefaultFiles();
app.UseStaticFiles();

// API routes (existing)
app.MapOpenApi();
app.MapHealthEndpoints();
...

// SPA fallback (last)
app.MapFallbackToFile("index.html");
```

This ensures:
- `/` serves index.html
- `/assets/xxx.js` serves static files
- `/api/*` routes to API endpoints
- `/any-spa-route` falls back to index.html for client routing
  </action>
  <verify>dotnet build succeeds without errors</verify>
  <done>Program.cs has UseDefaultFiles, UseStaticFiles, and MapFallbackToFile configured in correct order</done>
</task>

<task type="auto">
  <name>Task 2: Copy Svelte build output to wwwroot</name>
  <files>wwwroot/index.html, wwwroot/assets/*</files>
  <action>
Copy the contents of `web/dist/` to `wwwroot/`:

1. Remove any existing files in wwwroot (except .gitkeep if present)
2. Copy web/dist/* to wwwroot/
   - index.html
   - assets/ folder with CSS and JS bundles
   - Any other static assets (vite.svg, etc.)

Use recursive copy to preserve directory structure.

Note: This is a one-time manual copy. Phase 11 will automate this in the build process.
  </action>
  <verify>ls wwwroot/ shows index.html and assets/ folder with .js and .css files</verify>
  <done>wwwroot contains complete Svelte build output (index.html + assets/)</done>
</task>

<task type="auto">
  <name>Task 3: Test integrated app</name>
  <files>None (verification only)</files>
  <action>
Start the .NET app and verify full stack works:

1. Run `dotnet run` from project root
2. Open browser to http://localhost:5657
3. Verify:
   - Index page loads (Svelte app renders)
   - CSS styles are applied (Tailwind working)
   - API health check works: curl http://localhost:5657/api/health
   - Upload flow works (if CSV available for testing)

If any issues:
- Check browser console for 404s on assets
- Verify asset paths in index.html match wwwroot structure
- Check Network tab for failed API calls
  </action>
  <verify>curl http://localhost:5657 returns HTML containing Svelte app; curl http://localhost:5657/api/health returns healthy status</verify>
  <done>App loads at localhost:5657, serves Svelte UI, and API endpoints respond correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `dotnet build` succeeds without errors
- [ ] `dotnet run` starts server on port 5657
- [ ] http://localhost:5657 serves Svelte app (not 404)
- [ ] http://localhost:5657/api/health returns JSON response
- [ ] Static assets (JS, CSS) load without 404s
- [ ] No CORS errors in browser console
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Single `dotnet run` command serves both API and frontend
- No need to run separate Vite dev server for basic testing
</success_criteria>

<output>
After completion, create `.planning/phases/10-static-file-serving/10-01-SUMMARY.md`:

# Phase 10 Plan 01: Static File Serving Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `Program.cs` - Added static file middleware
- `wwwroot/*` - Svelte build output

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 11: Build Integration (automate Svelte build in .NET workflow)
</output>
