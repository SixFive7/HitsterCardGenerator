---
phase: 26-unified-rendering
plan: 02
type: execute
---

<objective>
Update Svelte components to use server-generated card images instead of CSS rendering.

Purpose: Achieve pixel-perfect preview-to-PDF consistency by displaying QuestPDF-rendered images in the browser.
Output: Updated CardFront.svelte and CardBack.svelte that fetch and display server-generated PNG images with preloading for smooth flip animations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-unified-rendering/26-CONTEXT.md
@.planning/phases/26-unified-rendering/26-RESEARCH.md
@.planning/phases/26-unified-rendering/26-01-SUMMARY.md

**Prior decisions affecting this phase:**
- CardCarousel uses Embla for carousel navigation (Phase 8)
- Card flip uses CSS 3D transforms with 0.6s transition
- Genre colors stored in genreColors prop passed to components

**Relevant source files:**
@web/src/lib/CardPreview/CardFront.svelte
@web/src/lib/CardPreview/CardBack.svelte
@web/src/lib/CardPreview/CardCarousel.svelte
@web/src/lib/types.ts

**Implementation notes from research:**
- Pre-fetch both front/back on carousel navigation for instant flips
- Use loading state while images load
- Cached images from server (10 min sliding expiration)
- Expected latency: 100-150ms first load, <50ms cached
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardImage component for server-rendered cards</name>
  <files>web/src/lib/CardPreview/CardImage.svelte</files>
  <action>
Create a new `CardImage.svelte` component that:

1. Accepts props:
   - `side: 'front' | 'back'` - Which card side to render
   - `trackId: string` - Spotify track ID
   - `title: string`, `artist: string`, `year: number`, `genre: string` - Card data
   - `backgroundColor: string` - Genre color hex

2. Fetches image from server:
   - Use `$effect` to fetch when props change
   - POST to `/api/card-preview/{side}` with card data
   - Convert response blob to object URL for `<img>` src
   - Handle loading state with simple spinner/placeholder
   - Handle error state with fallback message

3. Displays the image:
   - `<img>` with object URL as src
   - Maintain aspect ratio 17:11 (matching card proportions)
   - Include backface-visibility: hidden for 3D flip compatibility
   - Clean up object URLs on component destroy

4. Styling:
   - Match existing card dimensions (fill container)
   - Border radius and shadow matching current CardFront/CardBack
   - Loading spinner centered in card area
  </action>
  <verify>
Build succeeds: `cd web && npm run build`
No TypeScript errors
  </verify>
  <done>
- CardImage.svelte exists with side, trackId, title, artist, year, genre, backgroundColor props
- Fetches from /api/card-preview/{side} endpoint
- Displays loading state while fetching
- Shows image when loaded
- Handles errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CardFront and CardBack to use CardImage</name>
  <files>web/src/lib/CardPreview/CardFront.svelte, web/src/lib/CardPreview/CardBack.svelte</files>
  <action>
Replace the CSS-based rendering in both components with CardImage:

**CardFront.svelte:**
1. Remove the album art display and CSS styling
2. Import and use `<CardImage side="front" />` with all card props
3. Keep the existing container structure for flip animation compatibility
4. Pass through: trackId (from spotifyUrl or as new prop), title, artist, year, genre, backgroundColor

**CardBack.svelte:**
1. Remove all the text elements and CSS styling for year, artist, title, genre
2. Remove the brightness-based text color calculation (no longer needed)
3. Import and use `<CardImage side="back" />` with all card props
4. Keep the container with `transform: rotateY(180deg)` for flip animation

**Note:** The CardImage component handles all visual rendering now. The parent components just provide the container and flip transform.
  </action>
  <verify>
Build succeeds: `cd web && npm run build`
No TypeScript errors
  </verify>
  <done>
- CardFront.svelte uses CardImage with side="front"
- CardBack.svelte uses CardImage with side="back"
- Both maintain backface-visibility and transform for flip animation
- No CSS-based card text rendering remains
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CardCarousel to pass required props and add preloading</name>
  <files>web/src/lib/CardPreview/CardCarousel.svelte, web/src/lib/CardPreview/CardFront.svelte, web/src/lib/CardPreview/CardBack.svelte</files>
  <action>
Update CardCarousel to support the new CardImage-based components:

1. **Update prop passing:**
   - CardFront now needs: trackId, title, artist, year, genre, backgroundColor
   - CardBack already has: artist, year, title, genre, backgroundColor
   - Extract trackId from `card.match?.spotifyUrl` or use a utility to parse it

2. **Add preloading for flip smoothness:**
   - When a card becomes visible (selected in carousel), prefetch both sides
   - Create a simple `preloadCardImages(card, backgroundColor)` function
   - Call it in the Embla 'select' callback
   - Use fetch with `{cache: 'force-cache'}` to prime browser cache

3. **Prefetch adjacent cards:**
   - On carousel index change, also prefetch current-1 and current+1 cards
   - This ensures swiping is smooth

Implementation approach:
```typescript
function preloadCardImage(side: 'front' | 'back', cardData: object) {
  fetch(`/api/card-preview/${side}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(cardData),
    cache: 'force-cache'
  })
}
```
  </action>
  <verify>
Build succeeds: `cd web && npm run build`
No TypeScript errors
  </verify>
  <done>
- CardCarousel passes all required props to CardFront and CardBack
- Preloading function prefetches both card sides
- Adjacent cards are prefetched on carousel navigation
- Build succeeds with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated card preview system using server-rendered QuestPDF images</what-built>
  <how-to-verify>
    1. Run the application: `dotnet run` from project root
    2. Open browser to http://localhost:5000
    3. Upload a CSV or use playlist builder to add some songs
    4. Navigate to card preview screen
    5. Verify:
       - Cards display server-rendered images (not CSS-styled elements)
       - Front shows QR code (not album art placeholder)
       - Back shows year, artist, title, genre in QuestPDF styling
       - Card flip animation works smoothly
       - Swiping between cards is responsive
       - Changing genre colors updates the cards
    6. Export to PDF and compare:
       - Preview cards should look identical to PDF cards
       - Same fonts, sizes, colors, spacing
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] `dotnet build` succeeds without errors
- [ ] CardImage.svelte exists and fetches from API
- [ ] CardFront.svelte uses CardImage
- [ ] CardBack.svelte uses CardImage
- [ ] Card flip animation still works
- [ ] Cards display server-rendered images
- [ ] Preview matches PDF export (pixel-perfect)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification confirms pixel-perfect preview-to-PDF match
- Card flip animation remains smooth
- No visual regressions in the card preview UI
</success_criteria>

<output>
After completion, create `.planning/phases/26-unified-rendering/26-02-SUMMARY.md`
</output>
