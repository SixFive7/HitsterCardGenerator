---
phase: 08-card-preview
plan: 2
type: execute
---

<objective>
Add color customization, include/exclude controls, and integrate card preview into App.svelte.

Purpose: Complete the card preview experience with genre color picker, card curation, and flow integration.
Output: Working card preview step with color customization, include/exclude toggles, and visual verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-card-preview/08-CONTEXT.md
@.planning/phases/08-card-preview/08-RESEARCH.md
@.planning/phases/08-card-preview/08-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Svelte 5 runes pattern ($state, $derived, $effect) established in Phase 5
- Spotify-inspired colors (#1DB954 green, #FF6B6B coral, #191414 dark)
- Color picker: svelte-awesome-color-picker v4 with bind:hex

**From 08-CONTEXT.md (user vision):**
- Preset palettes first (Spotify vibes, neon, pastel), then per-genre fine-tuning
- Include/exclude toggle for card curation
- localStorage for color persistence

**Relevant source files:**
@web/src/App.svelte - Add 'preview' step after 'matched'
@web/src/lib/stores/cardCustomization.ts - From Plan 1
@web/src/lib/CardPreview/CardCarousel.svelte - From Plan 1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GenreColorPicker with preset palettes</name>
  <files>web/src/lib/ColorSettings/GenreColorPicker.svelte, web/src/lib/ColorSettings/ColorPalettes.svelte, web/src/lib/stores/cardCustomization.ts</files>
  <action>
1. Create web/src/lib/ColorSettings/ directory

2. Create ColorPalettes.svelte:
   - Define 4 preset palettes as Record<string, Record<string, string>>:
     - "Spotify" - use DEFAULT_GENRE_COLORS from store (current colors)
     - "Neon" - bright neon versions (#FF00FF, #00FFFF, #FF0080, etc.)
     - "Pastel" - soft pastel versions (lighten all colors)
     - "Grayscale" - gray variations (#333, #555, #777, etc.)
   - Display as clickable palette previews (4 small color swatches per palette)
   - On click, emit onSelectPalette(paletteName) to apply all colors

3. Create GenreColorPicker.svelte:
   - Props: genres (string[]) - unique genres from current cards
   - Import ColorPicker from 'svelte-awesome-color-picker'
   - State: selectedGenre ($state), show ColorPalettes at top
   - List all genres with their current color swatch
   - Click genre to select it, show ColorPicker bound to that genre's color
   - On color change, call setGenreColor(genre, hex) from store
   - Style: dark theme matching app (#282828 bg), compact layout

4. Update cardCustomization.ts:
   - Add applyPalette(palette: Record<string, string>) function
   - Add localStorage persistence: save on change, load on init
   - Key: 'hitster-genre-colors'
  </action>
  <verify>Components render without errors, color picker updates store, palette selection works</verify>
  <done>GenreColorPicker shows per-genre colors, ColorPalettes provides presets, localStorage persists</done>
</task>

<task type="auto">
  <name>Task 2: Create CardControls with include/exclude and navigation</name>
  <files>web/src/lib/CardPreview/CardControls.svelte, web/src/lib/stores/cardCustomization.ts</files>
  <action>
1. Create CardControls.svelte:
   - Props: totalCards, currentIndex, isIncluded, onPrev, onNext, onToggleInclude, onFlip
   - Layout: horizontal bar below carousel
   - Left: Previous button (disabled at index 0)
   - Center: "Card X of Y" counter, Include/Exclude toggle button
   - Right: Next button (disabled at last index), Flip button
   - Include toggle: green checkmark when included, red X when excluded
   - Style: match app theme, buttons with hover states

2. Update cardCustomization.ts:
   - Ensure toggleCardInclusion(index) works correctly
   - Add isCardIncluded(index) helper
   - Add getIncludedCount() derived value
   - Persist includedCards to localStorage (as array, convert to Set on load)
   - Key: 'hitster-included-cards'
  </action>
  <verify>Controls render, navigation updates currentIndex, include/exclude toggles persist</verify>
  <done>CardControls provides full navigation and curation, state persists to localStorage</done>
</task>

<task type="auto">
  <name>Task 3: Integrate 'preview' step in App.svelte</name>
  <files>web/src/App.svelte</files>
  <action>
1. Add 'preview' to currentStep type: 'landing' | 'upload' | 'results' | 'matching' | 'matched' | 'preview'

2. Import new components:
   - CardCarousel from './lib/CardPreview/CardCarousel.svelte'
   - CardControls from './lib/CardPreview/CardControls.svelte'
   - GenreColorPicker from './lib/ColorSettings/GenreColorPicker.svelte'
   - Import store functions: genreColors, includedCards, currentCardIndex, etc.

3. Add handleContinueToPreview() function:
   - Initialize includedCards with all card indexes (all included by default)
   - Set currentStep = 'preview'

4. Update 'matched' step:
   - Change disabled "Continue to Preview" button to enabled
   - onclick={handleContinueToPreview}

5. Add 'preview' step UI:
   - Header: "Preview Your Cards"
   - Two-column layout (responsive):
     - Left/Main: CardCarousel with matchResults
     - Right/Sidebar: GenreColorPicker (collapsible on mobile)
   - Below carousel: CardControls
   - Summary bar: "X of Y cards included"
   - Action buttons: "Back to Matches", "Continue to Export" (disabled, Phase 9)
   - Style: consistent with app theme

6. Wire up state:
   - Pass genreColors to CardCarousel
   - Sync currentCardIndex between carousel and controls
   - Pass unique genres from matchResults to GenreColorPicker
  </action>
  <verify>cd web && npm run build succeeds, no TypeScript errors</verify>
  <done>Preview step integrated, carousel shows cards, color picker works, controls navigate</done>
</task>

<task type="auto">
  <name>Task 4: Visual verification with webapp-testing</name>
  <files>None (verification only)</files>
  <action>
Use /webapp-testing skill to verify the card preview functionality:

1. Start servers: dotnet run (port 5000), cd web && npm run dev (port 5173)

2. Navigate through the full flow:
   - Upload a CSV file with songs
   - Click "Match with Spotify"
   - Click "Continue to Preview"

3. Verify card carousel:
   - Cards display with correct aspect ratio (17:11)
   - Click card to flip between front (album art) and back (info)
   - Navigation buttons work (prev/next)
   - Card counter shows correct position

4. Verify color customization:
   - Genre list shows all unique genres from uploaded songs
   - Clicking a genre opens color picker
   - Changing color updates card preview immediately
   - Palette selection applies colors to all genres

5. Verify include/exclude:
   - Toggle button changes between included/excluded state
   - Excluded cards show visual indicator
   - "X of Y cards included" summary updates

6. Take screenshots of:
   - Card front (album art)
   - Card back (with genre color)
   - Color picker with palette options
   - Include/exclude toggle states
  </action>
  <verify>All visual elements render correctly, interactions work smoothly</verify>
  <done>Card preview verified: carousel navigation, flip animation, color picker, include/exclude all functional</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] Preview step accessible from 'matched' state
- [ ] Cards flip with smooth CSS animation
- [ ] Color picker updates card colors immediately
- [ ] Include/exclude persists to localStorage
- [ ] Visual verification completed with webapp-testing
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Card preview provides complete customization experience
- Phase 8 complete, ready for Phase 9 (PDF Export)
</success_criteria>

<output>
After completion, create `.planning/phases/08-card-preview/08-02-SUMMARY.md`
</output>
