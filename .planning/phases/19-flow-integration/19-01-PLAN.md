---
phase: 19-flow-integration
plan: 01
type: execute
---

<objective>
Integrate playlist builder into app flow with landing page choice and direct-to-preview path.

Purpose: Complete v2.4 Features milestone by connecting playlist builder to card generation workflow.
Output: Unified app with two entry paths (CSV upload or Build Playlist) leading to same preview/export experience.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-flow-integration/19-CONTEXT.md
@.planning/phases/18-playlist-builder/18-01-SUMMARY.md
@.planning/phases/17-spotify-search/17-01-SUMMARY.md

**Key context from 19-CONTEXT.md:**
- Landing page with hero + two equal options: "Upload CSV" and "Build Playlist"
- Each path is one-way commit (no switching mid-flow)
- Build Playlist â†’ search/add â†’ preview (skip matching step)
- CSV Upload â†’ existing flow (CSV â†’ Match â†’ Preview)
- Out of scope: saving playlists, mixing modes, mode switching

**Relevant source files:**
@web/src/App.svelte
@web/src/lib/types.ts
@web/src/lib/stores/playlist.svelte.ts
@web/src/lib/SpotifySearch.svelte
@web/src/lib/PlaylistBuilder.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Landing Page Dual Path</name>
  <files>web/src/App.svelte</files>
  <action>
Transform landing page from single "Get Started" button to two equal path options:

1. Add flow mode state: `let flowMode = $state<'csv' | 'playlist' | null>(null)`

2. Replace "Get Started" button section with two equal cards:
   - "Upload CSV" card - icon: ðŸ“„, description: "Import songs from a CSV file", onClick sets flowMode='csv' and goes to 'upload' step
   - "Build Playlist" card - icon: ðŸŽµ, description: "Search Spotify and build your list", onClick sets flowMode='playlist' and goes to new 'build' step

3. Style both cards identically using existing card styling pattern (bg-[#282828], hover:scale-105, rounded-2xl). Place them in a 2-column grid below the feature highlights.

4. Add 'build' to the currentStep union type: `'landing' | 'upload' | 'build' | 'results' | ...`

5. Keep API status indicator and feature highlights as-is - they appear above the path choice.
  </action>
  <verify>App compiles without errors, landing page shows two path options</verify>
  <done>Landing page displays two equal options (Upload CSV / Build Playlist), clicking each navigates to respective step</done>
</task>

<task type="auto">
  <name>Task 2: Build Step Integration</name>
  <files>web/src/App.svelte, web/src/lib/stores/playlist.svelte.ts</files>
  <action>
1. Add build step UI in App.svelte (after upload step section):
   - Two-column layout: SpotifySearch on left, PlaylistBuilder on right
   - Import SpotifySearch and PlaylistBuilder components
   - Wire SpotifySearch's onAddTrack to playlist store's addTrack
   - Show "Continue to Preview" button when playlist has tracks (disabled when empty)
   - Add "Back to Home" link that clears playlist and returns to landing

2. Add conversion function to transform PlaylistTrack[] to MatchResult[]:
   ```typescript
   function playlistToMatchResults(tracks: PlaylistTrack[]): MatchResult[] {
     return tracks.map((track, index) => ({
       index,
       originalTitle: track.trackName,
       originalArtist: track.artistName,
       originalYear: track.releaseYear,
       originalGenre: track.genre,
       match: {
         trackId: track.trackId,
         trackName: track.trackName,
         artistName: track.artistName,
         albumName: track.albumName,
         albumImageUrl: track.albumImageUrl,
         spotifyUrl: track.spotifyUrl
       },
       confidence: 'high' as const,
       alternatives: []
     }))
   }
   ```

3. Add handler for "Continue to Preview" from build step:
   - Convert playlist tracks using playlistToMatchResults()
   - Set matchResults state with converted data
   - Initialize included cards
   - Navigate to 'preview' step (skip matching entirely)

4. Update "Back" button on preview step to be context-aware:
   - If flowMode === 'csv': go to 'matched' (existing behavior)
   - If flowMode === 'playlist': go to 'build'

5. Update handleStartNewBatch to also clear playlist and reset flowMode to null.

6. Import getPlaylistState from playlist store and use it to check track count.
  </action>
  <verify>npm run build succeeds, both flows work: CSV path goes through matching, playlist path skips to preview</verify>
  <done>Build step shows search + playlist side by side, "Continue to Preview" converts playlist to cards and skips matching, back navigation is flow-aware</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Landing page shows two equal path options
- [ ] CSV path: Upload â†’ Results â†’ Match â†’ Preview â†’ Export (unchanged)
- [ ] Playlist path: Build â†’ Preview â†’ Export (matching skipped)
- [ ] Back button on preview navigates correctly for each flow
- [ ] Starting new batch resets to landing with both options
</verification>

<success_criteria>

- Both entry paths functional and lead to preview/export
- Matching step correctly skipped for playlist-built tracks
- Flow is one-way (no mode switching mid-flow)
- Phase 19 and v2.4 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-flow-integration/19-01-SUMMARY.md`
</output>
