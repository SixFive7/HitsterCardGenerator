---
phase: 09-pdf-export
plan: 01
type: execute
---

<objective>
Create backend API for PDF export with cutting lines option.

Purpose: Enable the frontend to request PDF generation with customized genre colors and cutting line preferences.
Output: POST /api/export endpoint that returns a downloadable PDF file.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pdf-export/09-CONTEXT.md

**Existing PDF generation (reuse these patterns):**
@Services/PdfExporter.cs
@Services/QrCodeService.cs
@Models/CardData.cs

**Frontend types (match these in DTOs):**
@web/src/lib/types.ts

**Prior decisions affecting this phase:**
- Card size: 85x55mm (standard Hitster size)
- Layout: 2x5 grid (10 cards per A4 page)
- QuestPDF for PDF generation
- QRCoder for QR codes
- Genre colors stored in frontend, passed to backend for export
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportRequest and ExportResponse DTOs</name>
  <files>Models/ExportRequest.cs, Models/ExportResponse.cs</files>
  <action>
Create DTOs for the export endpoint:

**ExportRequest.cs:**
- Cards: List of card data (trackId, title, artist, year, genre) - only included cards from frontend
- GenreColors: Dictionary<string, string> mapping genre to hex color
- CuttingLines: enum (EdgeOnly, Complete) for cutting guide preference

**ExportResponse.cs:**
- Success: bool
- FileName: string (generated filename)
- CardCount: int
- PageCount: int

Use records for immutability. Match the frontend MatchResult structure for the card data.
  </action>
  <verify>dotnet build succeeds, no errors</verify>
  <done>DTOs created with all required properties</done>
</task>

<task type="auto">
  <name>Task 2: Add cutting lines option to PdfExporter</name>
  <files>Services/PdfExporter.cs</files>
  <action>
Modify PdfExporter to support cutting lines:

1. Add CuttingLineStyle enum parameter to ExportToPdf method (default: None for backward compat)
2. EdgeOnly mode: Draw lines only at page margins (top, bottom, left, right edges of grid)
3. Complete mode: Draw lines around each card (full grid)
4. None mode: Current behavior (light gray card borders only)

Implementation:
- Add helper method RenderCuttingLines(IContainer, CuttingLineStyle)
- Call it in page content before the card table
- Use thin black lines (0.5pt) for cutting guides
- Lines should extend slightly beyond card edges for easier cutting alignment

Keep existing border rendering for cards (0.25pt gray) regardless of cutting line setting.
  </action>
  <verify>dotnet build succeeds</verify>
  <done>PdfExporter accepts cutting line style, generates appropriate guides</done>
</task>

<task type="auto">
  <name>Task 3: Create POST /api/export endpoint</name>
  <files>Program.cs</files>
  <action>
Add export endpoint to Minimal API:

**POST /api/export:**
1. Accept ExportRequest JSON body
2. For each card in request:
   - Generate QR code using QrCodeService.GenerateQrCode(trackId)
   - Create CardData with: title, artist, year, genre, QR bytes, background color from genreColors dict
3. Call PdfExporter.ExportToPdf(cards, tempFilePath, cuttingLineStyle)
4. Generate smart filename: "hitster-cards-{count}-{date}.pdf" (e.g., "hitster-cards-25-2025-12-21.pdf")
5. Return PDF file with Content-Disposition header for download
6. Clean up temp file after response

Use Results.File() to return the PDF with correct content type (application/pdf).
Handle errors gracefully - return 400 for invalid request, 500 for generation failures.
  </action>
  <verify>
curl -X POST http://localhost:5000/api/export -H "Content-Type: application/json" -d '{"cards":[{"trackId":"test","title":"Test","artist":"Artist","year":2020,"genre":"Pop"}],"genreColors":{"Pop":"#FF69B4"},"cuttingLines":"None"}' --output test.pdf && file test.pdf
  </verify>
  <done>Endpoint returns valid PDF file, filename reflects content</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] POST /api/export accepts request and returns PDF
- [ ] PDF contains cards with correct genre colors
- [ ] Cutting lines render correctly (test EdgeOnly and Complete modes)
</verification>

<success_criteria>
- All tasks completed
- Export endpoint functional
- PDF generation includes genre colors from request
- Cutting lines option works (EdgeOnly, Complete, None)
</success_criteria>

<output>
After completion, create `.planning/phases/09-pdf-export/09-01-SUMMARY.md`
</output>
