---
phase: 09-pdf-export
plan: 02
type: execute
---

<objective>
Create frontend Export step with download UI and wire complete wizard flow.

Purpose: Provide one-click PDF export with cutting lines toggle and success feedback.
Output: Complete export step in wizard, functional PDF download, "start new batch" flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pdf-export/09-CONTEXT.md

**Frontend structure:**
@web/src/App.svelte
@web/src/lib/types.ts
@web/src/lib/stores/cardCustomization.svelte.ts
@web/src/lib/api.ts

**Design requirements from context:**
- One-click download simplicity
- Summary view with stats (card count, genres, pages)
- Cutting lines toggle (edge-only vs complete), persisted in localStorage
- Smart filename in download
- Success confirmation after download
- "Start new batch" option to restart wizard

**UI patterns to follow:**
- Spotify-inspired dark theme (#191414, #282828)
- Green accent (#1DB954) for primary actions
- Coral (#FF6B6B) for warnings/errors
- Rounded cards, smooth transitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportStep component</name>
  <files>web/src/lib/ExportStep.svelte, web/src/lib/api.ts, web/src/lib/types.ts</files>
  <action>
Create ExportStep.svelte with:

**Summary Section:**
- Card count (included only)
- Unique genres represented
- Estimated page count (Math.ceil(cardCount / 10) * 2 for front/back)

**Cutting Lines Toggle:**
- Radio buttons or toggle: "Edge lines only" vs "Complete grid lines"
- Store preference in localStorage key 'hitster-cutting-lines'
- Load preference on mount, default to 'edge'

**Download Button:**
- Large prominent button: "Download PDF"
- On click:
  1. Set loading state, show spinner
  2. Call exportPdf API function
  3. Trigger browser download with response blob
  4. Show success state

**Success State:**
- "Download started!" confirmation
- Show filename that was generated
- "Start New Batch" button

**API function in api.ts:**
```typescript
export async function exportPdf(request: ExportRequest): Promise<Blob>
```
- POST to /api/export with JSON body
- Return response as Blob for download

**Types in types.ts:**
- ExportRequest interface matching backend DTO
- CuttingLineStyle type: 'None' | 'EdgeOnly' | 'Complete'
  </action>
  <verify>npm run build succeeds in web/ directory</verify>
  <done>ExportStep component renders with all elements, API function defined</done>
</task>

<task type="auto">
  <name>Task 2: Wire wizard flow and start new batch</name>
  <files>web/src/App.svelte</files>
  <action>
Integrate ExportStep into App.svelte:

1. Add 'export' to currentStep type
2. Import ExportStep component
3. Add handleContinueToExport() - navigates from preview to export
4. Replace disabled "Continue to Export" button with functional one
5. Add export step section in template with ExportStep component

**Props to pass to ExportStep:**
- matchResults (filtered to included cards only using isCardIncluded)
- genreColors from customizationState
- onStartNewBatch callback

**handleStartNewBatch():**
- Reset all state: uploadResult, matchResults, matchError
- Clear localStorage for included cards (keep genre colors)
- Navigate to 'upload' step

**Data preparation for export:**
- Filter matchResults to only cards where isCardIncluded(index) is true
- Map to ExportRequest format with trackId from match.trackId
  </action>
  <verify>npm run build succeeds in web/ directory</verify>
  <done>Complete wizard flow: upload → results → matching → matched → preview → export → start new batch loops back</done>
</task>

<task type="auto">
  <name>Task 3: Automated E2E verification with webapp-testing</name>
  <files>test_export_flow.py</files>
  <action>
Create E2E test using webapp-testing skill to verify complete flow:

1. Upload test CSV file (create minimal test CSV with 2-3 songs)
2. Wait for validation results
3. Click "Match with Spotify"
4. Wait for matching to complete
5. Click "Continue to Preview"
6. Verify card carousel loads
7. Click "Continue to Export"
8. Verify export step shows correct card count
9. Toggle cutting lines option
10. Click "Download PDF"
11. Verify download initiates (check for success state)
12. Click "Start New Batch"
13. Verify returns to upload step

Use webapp-testing skill with Playwright to execute this flow.
Run with both servers (dotnet backend on 5657, npm dev on 5173).
  </action>
  <verify>E2E test passes, PDF downloads successfully</verify>
  <done>Complete flow verified end-to-end with automated test</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds in web/ directory
- [ ] Export step displays summary stats correctly
- [ ] Cutting lines toggle persists preference
- [ ] PDF download works with correct filename
- [ ] "Start New Batch" resets state and returns to upload
- [ ] E2E test passes full flow
</verification>

<success_criteria>
- All tasks completed
- Complete wizard flow functional
- PDF export works end-to-end
- Phase 9 complete - v2.0 milestone finished
</success_criteria>

<output>
After completion, create `.planning/phases/09-pdf-export/09-02-SUMMARY.md`

This is the final plan of Phase 9 and v2.0 milestone. Summary should note:
- v2.0 Web Interface milestone complete
- All 9 phases shipped
</output>
