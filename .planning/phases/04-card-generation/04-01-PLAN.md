---
phase: 04-card-generation
plan: 01
type: execute
---

<objective>
Generate QR codes linking to Spotify tracks for all matched songs.

Purpose: Create the visual element (QR code) that goes on the front of each card, enabling users to scan and play the song.
Output: QrCodeService that generates PNG byte arrays, GenerateQrStep UI with progress display, songs updated with QR data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions:**
- Spotify URL format: `open.spotify.com/track/{ID}`
- QRCoder library chosen for QR generation

**Existing code:**
@Models/Song.cs - Song record with SpotifyTrackId property
@Program.cs - Wizard loop, currently has placeholder for GenerateQR step
@UI/Steps/SpotifySearchStep.cs - Pattern for step with progress display

**Library research:**
- QRCoder: Use `PngByteQRCodeHelper.GetQRCode(url, ECCLevel.Q, pixelsPerModule)` for simple PNG generation
- Returns byte[] that can be stored in memory or written to file
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QRCoder package and create QrCodeService</name>
  <files>HitsterCardGenerator.csproj, Services/QrCodeService.cs</files>
  <action>
1. Add QRCoder NuGet package (latest stable)
2. Create QrCodeService with:
   - `GenerateQrCode(string spotifyTrackId)` returning byte[] (PNG)
   - URL format: `https://open.spotify.com/track/{spotifyTrackId}`
   - Use `PngByteQRCodeHelper.GetQRCode(url, QRCodeGenerator.ECCLevel.Q, 10)` - 10 pixels per module gives ~330px image, good for 85mm card width
   - Static method is fine (stateless service)
  </action>
  <verify>dotnet build succeeds, QRCoder package reference in .csproj</verify>
  <done>QrCodeService exists and can generate QR codes as PNG byte arrays</done>
</task>

<task type="auto">
  <name>Task 2: Create GenerateQrStep UI with progress display</name>
  <files>UI/Steps/GenerateQrStep.cs, Program.cs, Models/Song.cs</files>
  <action>
1. Add `QrCodeData` property to Song record: `public byte[]? QrCodeData { get; init; }`

2. Create GenerateQrStep with:
   - `GetProgressPanel(int current, int total, string currentSong)` - shows progress bar and current song being processed
   - `GenerateQrCodesAsync(List<Song> songs, Action<int, string> onProgress)` - generates QR codes for all songs, returns updated song list with QrCodeData populated
   - `GetSummaryPanel(int total)` - shows completion message

3. Update Program.cs:
   - Handle Step.GenerateQR case
   - Call GenerateQrCodesAsync with progress callback
   - Update appState.ValidSongs with QR data
   - Display summary panel
   - Advance to next step

Pattern from SpotifySearchStep for progress display.
  </action>
  <verify>dotnet build succeeds, run app through to GenerateQR step, verify QR codes are generated for each song</verify>
  <done>GenerateQrStep shows progress while generating QR codes, songs have QrCodeData populated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] QRCoder package listed in .csproj
- [ ] QrCodeService.GenerateQrCode returns valid PNG byte array
- [ ] GenerateQrStep displays progress during QR generation
- [ ] Songs have QrCodeData populated after step completes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- QR codes generated for all songs with Spotify track IDs
- Step advances to ColorChoice when complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-card-generation/04-01-SUMMARY.md`

# Phase 4 Plan 1: QR Code Generation Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 2
- **Files modified:** N

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Describe any deviations, or "None - plan executed exactly as written"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 04-02-PLAN.md (Color Choice + Card Design)
</output>
