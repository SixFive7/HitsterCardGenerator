---
phase: 04-card-generation
plan: 03
type: execute
---

<objective>
Generate PDF with cards arranged 16 per A4 page, complete wizard flow.

Purpose: Produce the final print-ready PDF with fronts and backs on separate pages, cutting guides, and complete the wizard experience.
Output: PdfExporter service, DesignCardsStep + ExportPdfStep UI, complete end-to-end wizard flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-card-generation/04-01-SUMMARY.md
@.planning/phases/04-card-generation/04-02-SUMMARY.md

**Prior decisions:**
- Card size: 85x55mm
- 16 cards per A4 (4x4 grid) - A4 is 210x297mm
- Separate pages for fronts and backs (double-sided printing)
- Cutting line indicators

**Existing code:**
@Services/CardDesigner.cs - From Plan 2, designs individual cards
@Models/CardData.cs - Card data model
@Program.cs - Wizard loop with placeholder for Steps 7-8
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PdfExporter service with A4 grid layout</name>
  <files>Services/PdfExporter.cs</files>
  <action>
1. Create PdfExporter service with:
   - `ExportToPdf(List<CardData> cards, bool useColors, string outputPath)`

2. PDF structure:
   - Each "sheet" = 2 pages (fronts page, backs page)
   - 16 cards per sheet in 4x4 grid
   - If 20 cards: Sheet 1 (16 cards), Sheet 2 (4 cards + 12 blank spaces)

3. Page layout (A4 = 210x297mm):
   - Card: 85x55mm
   - 4 columns x 4 rows = 340x220mm total card area
   - Margins to center: (210-170)/2 = 20mm horizontal (with 85mm cards, 4 won't fit - use 2 columns? No wait...)

   Actually recalculate:
   - 4 cards wide: 4 * 55mm = 220mm (cards are landscape, so 55mm is width on page)
   - 4 cards tall: 4 * 85mm = 340mm
   - This exceeds A4...

   Better approach - cards in PORTRAIT on page:
   - Card: 55mm wide x 85mm tall
   - 3 columns * 55mm = 165mm (fits in 210mm with margins)
   - 3 rows * 85mm = 255mm (fits in 297mm with margins)
   - 9 cards per page, not 16

   OR cards LANDSCAPE:
   - Card: 85mm wide x 55mm tall
   - 2 columns * 85mm = 170mm (fits in 210mm)
   - 5 rows * 55mm = 275mm (fits in 297mm)
   - 10 cards per page

   Let's go with 2x5 grid = 10 cards per page (landscape cards):
   - Horizontal margin: (210 - 170) / 2 = 20mm each side
   - Vertical margin: (297 - 275) / 2 = 11mm each side
   - Small gap between cards for cutting: 2mm

4. Use CardDesigner to render each card, place in grid using QuestPDF's Row/Column layout

5. Cutting guides:
   - Light gray dashed lines between cards
   - Use QuestPDF's Border or LineHorizontal/LineVertical elements

6. Back page ordering:
   - IMPORTANT: For double-sided printing, backs must be in MIRROR order
   - If fronts are [1,2] [3,4], backs must be [2,1] [4,3] so they align when printed duplex
   - Reverse each row's order for back pages

7. Generate PDF to outputPath using document.GeneratePdf(path)
  </action>
  <verify>dotnet build succeeds</verify>
  <done>PdfExporter generates multi-page PDF with cards in grid layout, cutting guides, properly ordered backs</done>
</task>

<task type="auto">
  <name>Task 2: Create DesignCardsStep + ExportPdfStep UI and complete wizard</name>
  <files>UI/Steps/DesignCardsStep.cs, UI/Steps/ExportPdfStep.cs, Program.cs</files>
  <action>
1. Create DesignCardsStep with:
   - `GetProgressPanel(int current, int total)` - shows progress creating card designs
   - `PrepareCardsAsync(List<Song> songs, bool useColors, Action<int> onProgress)` - creates CardData list from songs, returns List<CardData>
   - Convert Song to CardData (map genre to color if useColors)

2. Create ExportPdfStep with:
   - `GetContentPanel()` - shows export options
   - `PromptForOutputPath()` - ask user for output PDF path (default: "hitster-cards.pdf")
   - `GetExportingPanel()` - shows "Generating PDF..."
   - `GetCompletionPanel(string outputPath, int cardCount, int pageCount)` - success message with stats

3. Update Program.cs for Step.DesignCards:
   - Show progress while preparing CardData
   - Store in appState: `public List<CardData> CardData { get; set; }`
   - Advance to ExportPdf

4. Update Program.cs for Step.ExportPdf:
   - Prompt for output path
   - Show exporting panel with spinner
   - Call PdfExporter.ExportToPdf()
   - Show completion panel with file path and stats
   - Exit wizard loop (don't advance, just break)

5. Final completion message should include:
   - Output file path
   - Number of cards generated
   - Number of pages
   - Instructions: "Print double-sided, flip on short edge"
  </action>
  <verify>dotnet build succeeds, run full wizard flow from CSV to PDF export</verify>
  <done>Complete wizard flow works end-to-end, PDF is generated with all cards</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Hitster Card Generator wizard with PDF export</what-built>
  <how-to-verify>
    1. Run: dotnet run
    2. Import test CSV with 3-5 songs
    3. Complete Spotify authentication
    4. Let it search and match songs
    5. Generate QR codes (should show progress)
    6. Choose whether to use background colors
    7. Design cards (should show progress)
    8. Export PDF to a file
    9. Open the generated PDF and verify:
       - Cards are arranged in grid (2 columns x 5 rows)
       - Fronts page has QR codes
       - Backs page has year/artist/title/genre
       - If colors chosen, backgrounds have genre colors
       - Cutting guides visible between cards
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] Full wizard flow completes without errors
- [ ] PDF is generated at specified path
- [ ] Cards appear in correct grid layout
- [ ] Front and back pages are properly ordered for duplex printing
- [ ] Cutting guides are visible
- [ ] Background colors apply if selected
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Complete end-to-end workflow from CSV to PDF
- Phase 4 complete, project complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-card-generation/04-03-SUMMARY.md`

# Phase 4 Plan 3: PDF Export + Final Steps Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3 (2 auto + 1 human-verify)
- **Files modified:** N

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Describe any deviations, or "None - plan executed exactly as written"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Phase 4 complete - Hitster Card Generator is fully functional!

---
*Phase: 04-card-generation*
*Completed: [date]*
</output>
