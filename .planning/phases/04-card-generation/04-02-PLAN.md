---
phase: 04-card-generation
plan: 02
type: execute
---

<objective>
Implement color selection and card design services.

Purpose: Let users optionally add genre-based background colors, and create the card template designs (front with QR, back with song info).
Output: ColorChoiceStep UI, genre-color mapping, CardDesigner service generating front/back card images.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-card-generation/04-01-SUMMARY.md

**Prior decisions:**
- Card size: 85x55mm (credit card size)
- Optional genre-based background colors at 80% transparency
- Front: QR code centered
- Back: Year large/centered, artist above, title below, genre icon

**Existing code:**
@Models/Genre.cs - 35 valid genres defined
@Models/Song.cs - Song with QrCodeData from Plan 1
@Program.cs - Wizard loop

**Library research:**
- QuestPDF: Use Document.Create(), page.Size(width, height, Unit.Millimetre), Container for layout
- Images from byte[] via container.Image(bytes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create genre-color mapping and ColorChoiceStep UI</name>
  <files>Models/GenreColors.cs, UI/Steps/ColorChoiceStep.cs, Program.cs</files>
  <action>
1. Create GenreColors static class with:
   - Dictionary<string, string> mapping each genre to a hex color (35 colors for 35 genres)
   - Use distinct colors: Rock=red, Pop=pink, Hip-Hop=gold, Jazz=purple, Classical=navy, etc.
   - Include GetColorWithAlpha(string genre) returning color at 80% opacity (for backgrounds)
   - Colors should be visually distinct and genre-appropriate

2. Create ColorChoiceStep with:
   - `GetContentPanel()` - explains the color option, shows sample of a few genre colors
   - `PromptForChoice()` - yes/no prompt, returns bool
   - Simple panel showing "Would you like to add genre-based background colors to cards?"

3. Update Program.cs:
   - Handle Step.ColorChoice case
   - Store choice in AppState: `public bool UseBackgroundColors { get; set; }`
   - Advance to next step

Keep it simple - just a yes/no choice.
  </action>
  <verify>dotnet build succeeds, run app to ColorChoice step, verify prompt works</verify>
  <done>ColorChoiceStep prompts for background color preference, choice stored in AppState</done>
</task>

<task type="auto">
  <name>Task 2: Add QuestPDF and create CardDesigner service</name>
  <files>HitsterCardGenerator.csproj, Services/CardDesigner.cs, Models/CardData.cs</files>
  <action>
1. Add QuestPDF NuGet package (latest stable: 2025.x)
2. Set QuestPDF license: `QuestPDF.Settings.License = LicenseType.Community;` (in Program.cs startup)

3. Create CardData record:
   - Title, Artist, Year, Genre
   - QrCodeData (byte[])
   - BackgroundColor (string? hex, null if no colors)

4. Create CardDesigner service with:
   - `DesignFrontCard(CardData card)` returns IDocument (QuestPDF document)
     - Size: 85x55mm
     - QR code centered, sized to ~45mm square (leaving margin)
     - If BackgroundColor set, fill background with color

   - `DesignBackCard(CardData card)` returns IDocument
     - Size: 85x55mm
     - Layout (top to bottom): Artist (smaller font), Year (large, bold, centered), Title (medium font), Genre icon at bottom
     - If BackgroundColor set, fill background with color
     - Use clean sans-serif font (default)
     - Year should be prominent - it's the answer in the game

Use QuestPDF fluent API:
```csharp
Document.Create(container => {
    container.Page(page => {
        page.Size(85, 55, Unit.Millimetre);
        page.Content().Column(col => { ... });
    });
});
```
  </action>
  <verify>dotnet build succeeds, QuestPDF package in .csproj</verify>
  <done>CardDesigner can generate front and back card designs as QuestPDF documents</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] QuestPDF package listed in .csproj
- [ ] GenreColors has colors for all 35 genres
- [ ] ColorChoiceStep displays and accepts user choice
- [ ] CardDesigner.DesignFrontCard creates document with QR code
- [ ] CardDesigner.DesignBackCard creates document with song info
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Background color preference captured
- Card designs ready for PDF assembly
</success_criteria>

<output>
After completion, create `.planning/phases/04-card-generation/04-02-SUMMARY.md`

# Phase 4 Plan 2: Color Choice + Card Design Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 2
- **Files modified:** N

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Describe any deviations, or "None - plan executed exactly as written"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 04-03-PLAN.md (PDF Export + Final Steps)
</output>
