# Plan 28-01: Backend Card Redesign

## Objective

Update backend models and CardDesigner to implement the new card layout with album art, genre text on front, and restructured back layout with semi-transparent text bars.

## Prerequisites

- Phase 26 (Unified Rendering) complete
- Phase 27 (Simplify Color System) complete

## Execution Tasks

### Task 1: Update CardData model with album properties

**File:** `Models/CardData.cs`

Add new properties:
```csharp
public string? AlbumImageUrl { get; init; }
public string? AlbumName { get; init; }
```

Update `FromSong` factory method to include album data if available from Song model.

**Verification:** Code compiles without errors

---

### Task 2: Update CardPreviewRequest with album properties

**File:** `Endpoints/CardPreviewEndpoints.cs`

Add to `CardPreviewRequest` record:
```csharp
/// <summary>Album artwork URL from Spotify</summary>
public string? AlbumImageUrl { get; init; }

/// <summary>Album name</summary>
public string? AlbumName { get; init; }
```

Update both endpoint handlers to pass these values to `CardData`.

**Verification:** Code compiles without errors

---

### Task 3: Update CardPreviewCache with album in cache key

**File:** `Services/CardPreviewCache.cs`

Update `BackCardKey` to include `albumImageUrl` for cache invalidation:
```csharp
public static string BackCardKey(string trackId, int year, string? backgroundColor, string? albumImageUrl)
```

**Verification:** Code compiles without errors

---

### Task 4: Redesign CardDesigner front card layout

**File:** `Services/CardDesigner.cs`

Update `DesignFrontCard` to:
1. Keep genre background color fill
2. Center QR code (slightly smaller to make room for genre text)
3. Add genre text below QR code, centered
4. Choose text color based on background brightness (white for dark backgrounds, dark for light)

New layout:
```
+----------------------------------+
|        [GENRE BACKGROUND]        |
|          +--------+              |
|          |   QR   |              |
|          |  CODE  |              |
|          +--------+              |
|           "Genre"                |
+----------------------------------+
```

**Verification:** Compile succeeds

---

### Task 5: Create helper method for fetching album art

**File:** `Services/CardDesigner.cs`

Add static helper method to fetch album art from URL:
```csharp
private static byte[]? FetchAlbumImage(string? albumImageUrl)
```

- Use HttpClient to download image
- Cache result (simple static dictionary cache for session)
- Handle errors gracefully (return null on failure)
- Return byte array for QuestPDF Image component

**Verification:** Compile succeeds

---

### Task 6: Add brightness/contrast helper method

**File:** `Services/CardDesigner.cs`

Add helper to determine if a hex color is "dark" or "light":
```csharp
private static bool IsDarkColor(string? hexColor)
```

- Parse hex color to RGB
- Calculate luminance: (0.299*R + 0.587*G + 0.114*B)
- Return true if luminance < 128

This enables choosing contrasting text colors.

**Verification:** Compile succeeds

---

### Task 7: Redesign CardDesigner back card layout

**File:** `Services/CardDesigner.cs`

Update `DesignBackCard` to:
1. Full genre background color
2. Top bar: Year | Genre (with semi-transparent dark overlay)
3. Center: Album art (fetched and displayed)
4. Bottom bar: Artist - Title - Album (with semi-transparent dark overlay)

New layout:
```
+----------------------------------+
| [  Year | Genre  ]    <- top bar |
|                                  |
|        +------------+            |
|        |            |            |
|        | Album Art  |            |
|        |            |            |
|        +------------+            |
|                                  |
| [Artist - Title - Album] <- btm |
+----------------------------------+
```

Semi-transparent backgrounds:
- Use `Background("rgba(0,0,0,0.5)")` or similar for dark overlay
- Text in white for readability

Handle missing album art:
- Show placeholder or leave empty center area

**Verification:** Compile succeeds

---

### Task 8: Update ExportCard and ExportRequest with album data

**File:** `Models/ExportRequest.cs`

Add to `ExportCard`:
```csharp
public string? AlbumImageUrl { get; init; }
public string? AlbumName { get; init; }
```

**Verification:** Code compiles without errors

---

### Task 9: Update ExportEndpoints to pass album data

**File:** `Endpoints/ExportEndpoints.cs`

Update the card generation loop to include album data in CardData.

**Verification:** Code compiles without errors

---

### Task 10: Update PdfExporter render methods

**File:** `Services/PdfExporter.cs`

Update `RenderFrontCard` and `RenderBackCard` to match the new CardDesigner layouts:
- Front: QR code with genre text below
- Back: Top bar, album art center, bottom bar with text

Use same styling approach as CardDesigner for consistency.

**Verification:** `dotnet build` succeeds with no errors

---

## Completion Criteria

1. All models updated with album properties
2. CardDesigner implements new front/back layouts
3. Album art fetching works (with error handling)
4. PdfExporter uses matching layouts
5. Full build succeeds: `dotnet build`

## Next Steps

After this plan: Execute Plan 28-02 for frontend integration and visual verification.
