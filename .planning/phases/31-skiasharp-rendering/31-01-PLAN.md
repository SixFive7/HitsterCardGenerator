# Plan 31-01: SkiaSharp Rendering

---
phase: 31-skiasharp-rendering
type: execute
---

## Objective

Replace QuestPDF rendering in CardDesigner with SkiaSharp for high-quality bitmap rendering that serves as single source of truth for both web preview and PDF export.

**Purpose:** Unified SkiaSharp rendering produces pixel-perfect PNG images. Web preview uses these directly, and PDF export embeds these pre-rendered PNGs instead of re-rendering with QuestPDF.

**Output:** CardRenderer.cs with SkiaSharp rendering, updated CardDesigner.cs facade, updated PdfExporter.cs embedding PNGs.

## Context

**Current State:**
- CardDesigner.cs uses QuestPDF to render front/back card designs
- PdfExporter.cs duplicates card rendering logic using QuestPDF
- CardPreviewEndpoints.cs calls CardDesigner for web preview images
- SkiaSharp 3.116.1 already installed (can update to 3.119.1)
- Card size: 85x55mm (credit card size)

**Files to reference:**
- `Services/CardDesigner.cs` - Current QuestPDF implementation
- `Services/PdfExporter.cs` - Current PDF generation with QuestPDF
- `Endpoints/CardPreviewEndpoints.cs` - Web preview API
- `Models/CardData.cs` - Card data model

## Prerequisites

- Phase 30 (E2E Testing) complete
- SkiaSharp packages installed (already present)

## Execution Tasks

### Task 1: Update SkiaSharp to Latest Version

**Files:** `HitsterCardGenerator.csproj`

**Action:**
Update SkiaSharp packages from 3.116.1 to 3.119.1 (latest stable):
```xml
<PackageReference Include="SkiaSharp" Version="3.119.1" />
<PackageReference Include="SkiaSharp.NativeAssets.Linux" Version="3.119.1" />
```

**Verify:** `dotnet restore` succeeds

**Done:** SkiaSharp packages updated to 3.119.1

---

### Task 2: Create CardRenderer.cs with SkiaSharp Rendering

**Files:** `Services/CardRenderer.cs` (new file)

**Action:**
Create new service that renders cards using SkiaSharp:

1. Define constants matching CardDesigner:
   - CardWidth = 85mm, CardHeight = 55mm
   - QrSize = 40mm, BarHeight = 10mm
   - DPI = 300 (for high-quality output)
   - Convert mm to pixels: width * DPI / 25.4

2. Create static methods:
   - `RenderFrontCard(CardData card) -> byte[]` - Returns PNG bytes
   - `RenderBackCard(CardData card) -> byte[]` - Returns PNG bytes

3. Front card layout (matching current design):
   - Fill background with card.BackgroundColor
   - Draw QR code centered (from card.QrCodeData)
   - Draw genre text below QR code
   - Choose text color based on background brightness (white for dark, dark for light)

4. Back card layout (matching current design):
   - Fill background with card.BackgroundColor
   - Top bar: Semi-transparent black overlay with Year | Genre
   - Center: Album art (fetched from card.AlbumImageUrl)
   - Bottom bar: Semi-transparent black overlay with Artist - Title - Album

5. Helper methods:
   - `IsDarkColor(string? hexColor) -> bool` - Calculate luminance
   - `ParseHexColor(string hex) -> SKColor` - Parse hex to SkiaSharp color
   - `FetchAlbumImage(string? url) -> SKBitmap?` - Download and cache album art

6. Text rendering:
   - Use SKPaint with anti-aliasing enabled
   - Use SKTypeface.Default or similar for consistent font
   - Size text appropriately (convert pt to pixels at 300 DPI)

**Implementation notes:**
- Use SKBitmap and SKCanvas for rendering
- Use SKEncodedImageFormat.Png for output
- Cache album images with ConcurrentDictionary (like current implementation)
- Handle null/missing data gracefully

**Verify:** `dotnet build` succeeds

**Done:** CardRenderer.cs compiles with front/back rendering methods

---

### Task 3: Update CardDesigner.cs to Use CardRenderer

**Files:** `Services/CardDesigner.cs`

**Action:**
Simplify CardDesigner to be a facade that delegates to CardRenderer:

1. Keep existing public API:
   - `DesignFrontCard(CardData card) -> IDocument` (for backward compatibility if needed)
   - `DesignBackCard(CardData card) -> IDocument` (for backward compatibility if needed)
   - `GenerateFrontCardImage(CardData card) -> byte[]`
   - `GenerateBackCardImage(CardData card) -> byte[]`

2. Update `GenerateFrontCardImage` and `GenerateBackCardImage` to:
   - Delegate to CardRenderer.RenderFrontCard/RenderBackCard
   - Remove QuestPDF rendering code from these methods

3. Remove duplicate helper methods that are now in CardRenderer:
   - Move `IsDarkColor` to CardRenderer (or keep as shared if needed)
   - Move `FetchAlbumImage` and cache to CardRenderer
   - Remove HttpClient from CardDesigner

4. Option: Keep `DesignFrontCard`/`DesignBackCard` QuestPDF methods for legacy support, or remove them entirely since they're not used externally.

**Verify:** `dotnet build` succeeds

**Done:** CardDesigner delegates image generation to CardRenderer

---

### Task 4: Update PdfExporter.cs to Embed Pre-Rendered PNGs

**Files:** `Services/PdfExporter.cs`

**Action:**
Modify PDF generation to embed pre-rendered SkiaSharp images instead of re-rendering:

1. Update `RenderFrontCard(IContainer container, CardData card)`:
   - Call `CardRenderer.RenderFrontCard(card)` to get PNG bytes
   - Use QuestPDF's Image component to embed the PNG
   - Remove inline card rendering logic

2. Update `RenderBackCard(IContainer container, CardData card)`:
   - Call `CardRenderer.RenderBackCard(card)` to get PNG bytes
   - Use QuestPDF's Image component to embed the PNG
   - Remove inline card rendering logic

3. Remove duplicate code:
   - Remove `IsDarkColor`, `FetchAlbumImage` methods (now in CardRenderer)
   - Remove `AlbumImageCache` and `HttpClient` (now in CardRenderer)
   - Remove `QrSize`, `BarHeight` constants (rendering handled by CardRenderer)
   - Keep page layout constants: `CardWidth`, `CardHeight`, `Columns`, `Rows`, etc.

4. Keep cutting lines logic:
   - `GenerateCuttingLinesSvg` method stays unchanged
   - Page layout and grid structure stays unchanged

**Verify:** `dotnet build` succeeds

**Done:** PdfExporter embeds pre-rendered PNGs instead of re-rendering

---

### Task 5: Visual Verification with Chrome DevTools MCP

**Action:**
Run E2E test to verify cards render correctly with new SkiaSharp backend:

1. Start application:
   ```bash
   cd /workspaces/HitsterCardGenerator
   dotnet run
   ```

2. Navigate to http://localhost:5657 using Chrome DevTools MCP

3. Test CSV upload flow:
   - Upload test_data.csv
   - Match with Spotify
   - Verify card preview displays correctly (front with QR + genre)
   - Flip card and verify back displays correctly (album art, metadata bars)
   - Take screenshots for evidence

4. Test PDF export:
   - Continue to export
   - Download PDF
   - Verify download initiates

5. Document any visual differences from previous implementation

**Verify:**
- Cards display correctly in web preview
- Card flip shows both front and back
- PDF export completes successfully

**Done:** Visual verification confirms SkiaSharp rendering matches expected design

---

## Verification

Before declaring phase complete:
- [ ] `dotnet build` succeeds without errors
- [ ] Card preview API returns valid PNG images
- [ ] Front card shows: QR code centered, genre text below, colored background
- [ ] Back card shows: Year/Genre top bar, album art center, Artist/Title bottom bar
- [ ] PDF export generates valid PDF with embedded card images
- [ ] E2E test passes (upload -> match -> preview -> export)

## Success Criteria

1. SkiaSharp packages updated to 3.119.1
2. CardRenderer.cs created with SkiaSharp rendering
3. CardDesigner.cs simplified to delegate to CardRenderer
4. PdfExporter.cs embeds pre-rendered PNGs (not re-rendering)
5. Visual verification confirms cards render correctly
6. No QuestPDF rendering code remains for individual cards (QuestPDF only for PDF page layout)

## Technical Notes

**DPI Calculation:**
- At 300 DPI: 85mm = 1003 pixels, 55mm = 650 pixels
- Formula: pixels = mm * 300 / 25.4

**SkiaSharp Color Parsing:**
- Parse hex "#RRGGBB" to SKColor
- Handle alpha for semi-transparent overlays: "#000000B3" = 70% opacity black

**Album Art Caching:**
- Reuse ConcurrentDictionary pattern from current implementation
- Download images with HttpClient, convert to SKBitmap
- Cache for session duration

## Output

After completion, create `.planning/phases/31-skiasharp-rendering/31-01-SUMMARY.md`:

```markdown
# Phase 31: SkiaSharp Rendering Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [ ] Item 1
- [ ] Item 2

## Files Created/Modified

- `Services/CardRenderer.cs` - New SkiaSharp rendering service
- `Services/CardDesigner.cs` - Simplified to delegate to CardRenderer
- `Services/PdfExporter.cs` - Updated to embed pre-rendered PNGs
- `HitsterCardGenerator.csproj` - Updated SkiaSharp versions

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| ... | ... |

## Issues Encountered

None / List any issues

## Next Phase Readiness

Milestone v2.9 complete. Ready for next milestone or feature work.
```
