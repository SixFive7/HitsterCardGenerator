---
phase: 03-spotify-integration
plan: 01
type: execute
---

<objective>
Set up Spotify API authentication with client credentials flow and create the credentials input step.

Purpose: Enable the app to authenticate with Spotify's Web API so subsequent steps can search for tracks.
Output: SpotifyService with working authentication, SpotifyCredentialsStep UI integrated into wizard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Columns layout instead of Layout (better prompt integration)
- Prompts integrated INTO content panels for natural flow
- Service pattern established (GenreValidator, CsvParser)

**Existing patterns to follow:**
@Program.cs - Wizard loop structure, step routing
@UI/Steps/ImportCsvStep.cs - Step UI pattern with GetContentPanel + Prompt
@Services/GenreValidator.cs - Service class pattern

**Discovery findings:**
- SpotifyAPI-NET is the standard .NET library (NuGet: SpotifyAPI.Web)
- Client credentials flow: POST to token endpoint with client_id + client_secret
- No user authorization needed (we only search public track data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SpotifyAPI.Web package and create SpotifyService</name>
  <files>HitsterCardGenerator.csproj, Services/SpotifyService.cs</files>
  <action>
    1. Add NuGet package: `dotnet add package SpotifyAPI.Web`
    2. Create Services/SpotifyService.cs with:
       - Constructor taking clientId and clientSecret
       - Private SpotifyClient field
       - `AuthenticateAsync()` method that:
         - Uses ClientCredentialsAuthenticator from SpotifyAPI.Web
         - Creates SpotifyClient with the token
         - Returns true on success, false on auth failure
       - `IsAuthenticated` property to check if client is ready
    3. Keep it simple - no retry logic, no caching (per project constraints)
  </action>
  <verify>
    - `dotnet build` succeeds
    - SpotifyService.cs exists with AuthenticateAsync method
  </verify>
  <done>SpotifyService compiles with client credentials auth flow</done>
</task>

<task type="auto">
  <name>Task 2: Create SpotifyCredentialsStep UI</name>
  <files>UI/Steps/SpotifyCredentialsStep.cs, Program.cs, Models/WizardState.cs (if needed)</files>
  <action>
    1. Create UI/Steps/SpotifyCredentialsStep.cs following ImportCsvStep pattern:
       - `GetContentPanel(string? errorMessage)` - Shows:
         - Instructions for getting Spotify API credentials
         - Link: https://developer.spotify.com/dashboard
         - Error message if provided (red)
         - Prompt text: "Enter your Spotify Client ID:"
       - `PromptForCredentials()` method that:
         - Prompts for Client ID (text prompt with `>`)
         - Prompts for Client Secret (text prompt with `>`, consider masking)
         - Returns (clientId, clientSecret) tuple
       - `ValidateCredentials(SpotifyService service)` async method that:
         - Calls service.AuthenticateAsync()
         - Returns error message if failed, null if success
    2. Update Program.cs to add Step.SpotifyCredentials case:
       - Create SpotifyService instance
       - Loop until valid credentials (like ImportCsvStep pattern)
       - Store credentials or service in AppState
       - Advance to next step on success
    3. Add SpotifyService to AppState for use in later steps
  </action>
  <verify>
    - `dotnet build` succeeds
    - SpotifyCredentialsStep.cs exists with GetContentPanel and PromptForCredentials
    - Program.cs has SpotifyCredentials case in switch
  </verify>
  <done>Credentials step prompts for client ID/secret and validates against Spotify API</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Spotify authentication flow with credentials UI step</what-built>
  <how-to-verify>
    1. Run: `dotnet run`
    2. Import a valid CSV file (use test-songs.csv)
    3. Validate CSV and continue
    4. At Step 3 (Spotify Credentials):
       - Verify instructions panel shows how to get credentials
       - Enter your Spotify Client ID and Secret
       - Confirm authentication succeeds (advances to Step 4)
    5. Test with invalid credentials:
       - Restart app, re-import CSV
       - Enter wrong credentials
       - Confirm error message appears and re-prompts
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] SpotifyAPI.Web package added to csproj
- [ ] SpotifyService authenticates with valid credentials
- [ ] SpotifyCredentialsStep UI displays correctly in wizard
- [ ] Invalid credentials show error and re-prompt
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Wizard advances from CSV validation to Spotify credentials step
- Authentication works with valid Spotify API credentials
- Error handling works for invalid credentials
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-01-SUMMARY.md`
</output>
