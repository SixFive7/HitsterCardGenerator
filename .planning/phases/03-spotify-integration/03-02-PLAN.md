---
phase: 03-spotify-integration
plan: 02
type: execute
---

<objective>
Implement Spotify track search with smart selection logic and interactive fallback for ambiguous matches.

Purpose: Match each song from the CSV to a Spotify track ID, preferring original releases over compilations/remasters.
Output: SpotifySearchStep UI that processes all songs and stores Spotify track IDs in Song records.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spotify-integration/03-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Columns layout for prompt integration
- Service pattern (SpotifyService exists with auth)
- Song record has SpotifyTrackId property (nullable)

**Discovery findings:**
- Search endpoint: Use `artist:` and `track:` filters for better results
- album_type is NOT a search filter - must filter results client-side
- Prefer tracks where album.album_type == "album" over "compilation" or "single"
- Avoid "remastered" in track/album names when original exists

**Smart selection logic (priority order):**
1. Exact artist + title match on original album (album_type == "album")
2. Exact match on single (album_type == "single")
3. Exact match on compilation (album_type == "compilation")
4. Fuzzy match - if no exact match, present options to user

**Existing patterns to follow:**
@Program.cs - Wizard loop, step routing
@UI/Steps/ValidateCsvStep.cs - Table display pattern
@Services/SpotifyService.cs - Service with authenticated client
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search methods to SpotifyService</name>
  <files>Services/SpotifyService.cs, Models/SpotifySearchResult.cs</files>
  <action>
    1. Create Models/SpotifySearchResult.cs:
       - TrackId (string)
       - TrackName (string)
       - ArtistName (string)
       - AlbumName (string)
       - AlbumType (string) - "album", "single", "compilation"
       - ReleaseYear (int)
       - IsRemastered (bool) - true if "remaster" in track/album name
       - SpotifyUrl (string) - open.spotify.com/track/{id}

    2. Add to SpotifyService:
       - `SearchTrackAsync(string artist, string title)` method:
         - Build query: `track:{title} artist:{artist}`
         - Call SpotifyClient.Search.Item with type=Track, limit=10
         - Map results to List<SpotifySearchResult>
         - Set IsRemastered by checking track.Name and album.Name for "remaster" (case-insensitive)

       - `SelectBestMatch(List<SpotifySearchResult> results, string artist, string title)` method:
         - Returns single SpotifySearchResult or null if ambiguous
         - Priority: album > single > compilation
         - Prefer non-remastered over remastered
         - If multiple equal-priority matches, return null (ambiguous)
  </action>
  <verify>
    - `dotnet build` succeeds
    - SpotifySearchResult.cs exists with all properties
    - SpotifyService has SearchTrackAsync and SelectBestMatch methods
  </verify>
  <done>Search methods compile and implement smart selection logic</done>
</task>

<task type="auto">
  <name>Task 2: Create SpotifySearchStep UI</name>
  <files>UI/Steps/SpotifySearchStep.cs, Program.cs</files>
  <action>
    1. Create UI/Steps/SpotifySearchStep.cs:
       - `ProcessSongsAsync(List<Song> songs, SpotifyService service, Action<IRenderable, IRenderable> renderCallback)`:
         - Iterate through songs
         - For each song:
           a. Update progress panel (show current song X of Y)
           b. Call SearchTrackAsync
           c. Call SelectBestMatch
           d. If match found: update song with SpotifyTrackId
           e. If no results: mark as "Not found"
           f. If ambiguous: call PromptForSelection
         - Return updated List<Song> with SpotifyTrackIds populated

       - `GetProgressPanel(int current, int total, string currentSong, string? status)`:
         - Shows progress bar
         - Shows current song being searched
         - Shows status (Searching... / Found / Not found / Manual selection needed)

       - `PromptForSelection(string artist, string title, List<SpotifySearchResult> options)`:
         - Show table of options (album, artist, year, type)
         - Use Spectre.Console SelectionPrompt
         - Include "Skip this song" option
         - Return selected SpotifySearchResult or null if skipped

       - `GetSummaryPanel(List<Song> songs)`:
         - Shows table: Song | Status (Found/Not Found/Skipped)
         - Shows counts: X found, Y not found, Z skipped

    2. Update Program.cs Step.SpotifySearch case:
       - Get SpotifyService from AppState
       - Call ProcessSongsAsync with songs from AppState
       - Store updated songs back to AppState
       - Show summary panel
       - Prompt to continue or go back
  </action>
  <verify>
    - `dotnet build` succeeds
    - SpotifySearchStep.cs exists with ProcessSongsAsync and helper methods
    - Program.cs has SpotifySearch case
  </verify>
  <done>Search step processes all songs with progress display and manual selection fallback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Spotify search flow with smart selection and manual fallback</what-built>
  <how-to-verify>
    1. Create test CSV with mix of:
       - Easy matches (e.g., "Bohemian Rhapsody;Queen;1975;Rock")
       - Potential ambiguous (e.g., songs with many cover versions)
       - Unlikely to find (e.g., "Nonexistent Song;Unknown Artist;2000;Pop")

    2. Run: `dotnet run`
    3. Import test CSV, validate, enter Spotify credentials
    4. At Step 4 (Spotify Search):
       - Verify progress display shows current song
       - Watch for automatic matches (should prefer original albums)
       - If manual selection appears:
         - Verify table shows album type and year
         - Select an option or skip
       - After all songs processed:
         - Verify summary shows found/not found/skipped counts

    5. Confirm songs now have SpotifyTrackId populated (visible in next step or logs)
  </how-to-verify>
  <resume-signal>Type "approved" to continue to Phase 4, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] SearchTrackAsync returns results from Spotify API
- [ ] SelectBestMatch prioritizes original albums over compilations
- [ ] Manual selection UI works for ambiguous matches
- [ ] Progress display updates during search
- [ ] Summary shows accurate found/not found counts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Songs are matched to Spotify track IDs using smart selection
- Ambiguous matches prompt user for manual selection
- Search flow integrates smoothly into wizard
- Phase 3 complete - ready for Phase 4 (Card Generation)
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-02-SUMMARY.md`
</output>
